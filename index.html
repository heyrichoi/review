<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>클래시 로얄 월간 커뮤니티 리뷰 시스템</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1a1a1a;
            --secondary: #ffffff;
            --accent: #4f46e5;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --border: #e5e7eb;
            --hover: #f9fafb;
            --text: #111827;
            --text-muted: #6b7280;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --transition: all 0.2s ease;
            
            /* 브랜드 컬러 */
            --clash-blue: #1e3a8a;
            --clash-gold: #f59e0b;
            --youtube-red: #ff0000;
            --naver-green: #00c73c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f8fafc;
            color: var(--text); 
            line-height: 1.6;
        }

        .container { display: flex; min-height: 100vh; }

        .sidebar {
            width: 300px;
            background: var(--secondary);
            box-shadow: var(--shadow-lg);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid var(--border);
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--clash-blue), var(--clash-gold));
            color: white;
            text-align: center;
        }

        .sidebar-header h1 { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 8px;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .period-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .period-selector select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 13px;
            font-weight: 500;
            appearance: none;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .period-selector select:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .current-period {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .nav-menu { padding: 16px 0; }

        .nav-section {
            padding: 12px 20px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text);
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-item::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            margin-right: 12px;
            opacity: 0;
            transition: var(--transition);
        }

        .nav-item:hover, .nav-item.active {
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.1), transparent);
            border-left-color: var(--accent);
            color: var(--accent);
        }

        .nav-item:hover::before, .nav-item.active::before {
            opacity: 1;
        }

        .control-buttons {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px 14px;
            background: var(--clash-blue);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: var(--transition);
        }

        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .control-btn.secondary {
            background: var(--clash-gold);
        }

        .main-content {
            margin-left: 300px;
            flex: 1;
            background: #f8fafc;
            min-height: 100vh;
        }

        .page-section {
            margin: 0;
            padding: 40px;
            background: var(--secondary);
            border-bottom: 1px solid var(--border);
            min-height: 100vh;
            page-break-after: always;
        }

        .cover-page {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #f59e0b 100%);
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .cover-title {
            font-size: 48px;
            font-weight: 900;
            margin-bottom: 16px;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .cover-subtitle {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        .cover-version {
            font-size: 16px;
            margin-bottom: 32px;
            opacity: 0.8;
        }

        .logo-container {
            display: flex;
            gap: 60px;
            margin: 40px 0;
            align-items: center;
        }

        .logo-item {
            text-align: center;
        }

        .logo-item img {
            height: 80px;
            width: auto;
            margin-bottom: 12px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--clash-blue);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 32px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
            background: var(--secondary);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            font-size: 13px;
        }

        .data-table th {
            background: var(--youtube-red);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            border: 1px solid #cc0000;
        }

        .data-table.naver th {
            background: var(--naver-green);
            border-color: #00a832;
        }

        .data-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid var(--border);
            font-size: 12px;
        }

        .data-table tr:nth-child(even) {
            background: #f9fafb;
        }

        .data-table .positive {
            color: var(--success);
            font-weight: 700;
        }

        .data-table .negative {
            color: var(--error);
            font-weight: 700;
        }

        .chart-container {
            background: var(--secondary);
            border-radius: var(--radius);
            padding: 24px;
            margin: 24px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .video-card {
            background: var(--secondary);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .video-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .video-thumbnail {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .video-info {
            padding: 16px;
        }

        .video-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .video-stats {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .video-link {
            display: inline-block;
            padding: 6px 12px;
            background: var(--youtube-red);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }

        .video-link:hover {
            background: #cc0000;
        }

        .insights-panel {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: var(--radius);
            padding: 24px;
            margin: 24px 0;
            border-left: 4px solid var(--info);
        }

        .insights-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .insight-item {
            background: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid var(--info);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: text; /* Make it look editable */
        }

        .insight-item:empty:before {
            content: "클릭하여 텍스트를 입력하세요...";
            color: #aaa;
        }

        .insight-item.positive {
            border-left-color: var(--success);
        }

        .insight-item.negative {
            border-left-color: var(--error);
        }

        .insight-item.warning {
            border-left-color: var(--warning);
        }

        .age-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .age-card {
            background: var(--secondary);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .age-card h4 {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .age-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--clash-blue);
            margin-bottom: 4px;
        }

        .age-card .change {
            font-size: 12px;
            font-weight: 600;
        }

        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .admin-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .admin-panel {
            background: var(--secondary);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: translateY(20px);
            transition: var(--transition);
        }

        .admin-modal.active .admin-panel {
            transform: translateY(0);
        }

        .admin-header {
            background: var(--clash-blue);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .admin-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .admin-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text);
            background: var(--secondary);
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        .file-upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            background: var(--hover);
            transition: var(--transition);
            margin: 16px 0;
        }

        .file-upload-zone:hover, .file-upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(79, 70, 229, 0.05);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary);
            color: var(--text);
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 10001;
            max-width: 350px;
            font-size: 14px;
        }

        .notification.show {
            opacity: 1;
            visibility: visible;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification.info {
            border-left: 4px solid var(--info);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .page-section {
                padding: 24px 16px;
            }
            
            .cover-title {
                font-size: 32px;
            }
            
            .logo-container {
                flex-direction: column;
                gap: 30px;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
        }

        .sample-data-section {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
        }

        .sample-data-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sample-btn {
            padding: 8px 12px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }

        .sample-btn:hover {
            background: #0284c7;
        }

        .custom-content-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .custom-content-controls button {
            background: var(--accent);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .custom-content-controls button:hover {
            background: #3e38b2;
        }

        .editable-content-wrapper {
            margin-bottom: 20px;
            border: 1px dashed var(--border);
            padding: 15px;
            border-radius: var(--radius);
            background: #fdfdfd;
        }

        .editable-content-wrapper .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .editable-content-wrapper .content-header button {
            background: none;
            border: none;
            color: var(--error);
            font-size: 18px;
            cursor: pointer;
        }

        .editable-text-block {
            min-height: 50px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #fff;
            margin-top: 10px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .editable-text-block:focus {
            border-color: var(--accent);
        }

        .editable-image-block {
            text-align: center;
            margin-top: 10px;
        }

        .editable-image-block img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }

        .editable-image-block input[type="text"] {
            width: calc(100% - 20px);
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .ai-issue-button {
            margin-top: 20px;
            background: var(--info);
        }
    </style>
</head>
<body>
    <!-- 관리자 패널 -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-panel">
            <div class="admin-header">
                <h2>📊 데이터 관리 패널</h2>
                <button class="admin-close" onclick="closeAdminPanel()">&times;</button>
            </div>
            
            <div class="admin-content">
                <div class="sample-data-section">
                    <h4>🎯 실제 Excel 파일 업로드 (권장)</h4>
                    <p style="font-size: 12px; color: var(--text-muted); margin: 8px 0;">
                        <strong>필수 시트:</strong> 'Naver Cafe', 'Youtube', 'Youtube(ALL)', 'Youtube community'<br>
                        Excel 파일이면 자동으로 모든 시트를 인식하고 계산합니다.
                    </p>
                    <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin: 8px 0; font-size: 12px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">✅ 자동 처리 기능:</div>
                        <div>• 각 시트별 데이터 품질 자동 검증</div>
                        <div>• 합계, 평균, 성장률 자동 계산</div>
                        <div>• 누락된 필드 자동 감지 및 알림</div>
                        <div>• AI가 임의로 데이터 생성하지 않음</div>
                    </div>
                </div>

                <div class="sample-data-section" style="background: #fff8dc; border-color: var(--warning);">
                    <h4>📋 CSV 샘플 다운로드 (참고용)</h4>
                    <p style="font-size: 12px; color: var(--text-muted); margin: 8px 0;">Excel 파일 형식 참고용</p>
                    <div class="sample-data-buttons">
                        <button class="sample-btn" onclick="downloadSample('youtube-total')">YouTube 월별</button>
                        <button class="sample-btn" onclick="downloadSample('youtube-detail')">YouTube 영상별</button>
                        <button class="sample-btn" onclick="downloadSample('naver-cafe')">Naver Cafe</button>
                        <button class="sample-btn" onclick="downloadSample('dau')">DAU</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">📁 파일 업로드</label>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                        <strong>Excel 파일 (.xlsx)</strong>: 모든 시트 자동 인식 및 처리 <span style="color: var(--success);">✨ 권장</span><br>
                        <strong>CSV 파일 (.csv)</strong>: 단일 데이터 유형만 처리
                    </div>
                </div>

                <div class="form-group" id="csvDataTypeGroup" style="display: none;">
                    <label class="form-label">CSV 데이터 유형</label>
                    <select class="form-select" id="dataTypeSelector" onchange="updateUploadInfo()">
                        <option value="">CSV 데이터 유형을 선택하세요</option>
                        <option value="youtube-total">YouTube 3개월 종합 데이터</option>
                        <option value="youtube-detail">YouTube 영상별 상세 데이터</option>
                        <option value="naver-cafe">Naver Cafe 3개월 데이터</option>
                        <option value="dau">DAU (Daily Active Users) 데이터</option>
                    </select>
                </div>

                <div class="file-upload-zone" id="fileUploadZone">
                    <div style="font-size: 28px; margin-bottom: 8px;">📊</div>
                    <div style="font-size: 16px; margin-bottom: 8px; font-weight: 600;">Excel 또는 CSV 파일 업로드</div>
                    <div style="font-size: 13px; color: var(--text-muted);">
                        Excel 파일: 모든 시트 자동 인식<br>
                        CSV 파일: 드래그 앤 드롭 또는 클릭
                    </div>
                    <input type="file" accept=".xlsx,.xls,.csv" style="display: none;">
                </div>

                <div id="dataQualityInfo" style="display: none; margin: 16px 0;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">데이터 품질 분석</div>
                    <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="qualityBar" style="background: var(--success); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="qualityText" style="font-size: 12px; margin-top: 4px; color: var(--text-muted);">품질 점수: 0%</div>
                </div>

                <div id="excelAnalysisResult"></div> <!-- Excel 분석 결과 표시 영역 -->

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="control-btn" onclick="processUploadedData()">📊 데이터 적용</button>
                    <button class="control-btn secondary" onclick="generateReport()">📄 리포트 생성</button>
                </div>

                <div class="custom-content-controls">
                    <button onclick="openAddCustomContentModal()">➕ 커스텀 콘텐츠 추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 커스텀 콘텐츠 추가 모달 -->
    <div class="admin-modal" id="addCustomContentModal">
        <div class="admin-panel">
            <div class="admin-header">
                <h2>➕ 커스텀 콘텐츠 추가</h2>
                <button class="admin-close" onclick="closeAddCustomContentModal()">&times;</button>
            </div>
            <div class="admin-content">
                <div class="form-group">
                    <label class="form-label">콘텐츠를 추가할 섹션 선택</label>
                    <select class="form-select" id="contentSectionSelector">
                        <option value="youtube-total">📺 YouTube 종합</option>
                        <option value="youtube-charts">📊 YouTube 차트</option>
                        <option value="youtube-detail">🎬 YouTube 상세</option>
                        <option value="naver-total">💬 Naver Cafe 종합</option>
                        <option value="naver-charts">📈 Naver Cafe 차트</option>
                        <option value="youtube-community">📱 YouTube 커뮤니티</option>
                        <option value="age-analysis">👥 연령층 분석</option>
                        <option value="key-issues">🔑 주요 이슈</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">콘텐츠 유형</label>
                    <select class="form-select" id="contentTypeSelector">
                        <option value="text">텍스트 블록</option>
                        <option value="image">이미지 블록</option>
                    </select>
                </div>
                <div id="textInputGroup" class="form-group">
                    <label class="form-label">텍스트 내용</label>
                    <textarea class="form-textarea" id="customContentText" rows="5" placeholder="여기에 텍스트를 입력하세요."></textarea>
                </div>
                <div id="imageInputGroup" class="form-group" style="display: none;">
                    <label class="form-label">이미지 URL</label>
                    <input type="text" class="form-input" id="customContentImageUrl" placeholder="이미지 URL을 입력하세요.">
                    <label class="form-label" style="margin-top: 10px;">이미지 설명 (alt text)</label>
                    <input type="text" class="form-input" id="customContentImageAlt" placeholder="이미지 설명을 입력하세요.">
                </div>
                <button class="control-btn" onclick="addCustomContent()">콘텐츠 추가</button>
            </div>
        </div>
    </div>


    <div class="container">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>월간 커뮤니티 리뷰</h1>
                <div class="subtitle">Clash Royale</div>
                <div class="period-selector">
                    <select id="yearSelector"></select>
                    <select id="monthSelector"></select>
                </div>
                <div class="current-period" id="currentPeriod">2025년 6월</div>
            </div>
            
            <div class="nav-menu">
                <div class="nav-section">📋 리포트 섹션</div>
                <a href="#cover" class="nav-item active">📑 표지</a>
                <a href="#youtube-total" class="nav-item">📺 YouTube 종합</a>
                <a href="#youtube-charts" class="nav-item">📊 YouTube 차트</a>
                <a href="#youtube-detail" class="nav-item">🎬 YouTube 상세</a>
                <a href="#naver-total" class="nav-item">💬 Naver Cafe 종합</a>
                <a href="#naver-charts" class="nav-item">📈 Naver Cafe 차트</a>
                <a href="#youtube-community" class="nav-item">📱 YouTube 커뮤니티</a>
                <a href="#age-analysis" class="nav-item">👥 연령층 분석</a>
                <a href="#key-issues" class="nav-item">🔑 주요 이슈</a>
            </div>
            
            <div class="control-buttons">
                <button class="control-btn" onclick="openAdminPanel()">📊 데이터 관리</button>
                <button class="control-btn secondary" onclick="exportToPDF()">📥 PDF 내보내기</button>
            </div>
        </nav>

        <!-- 메인 콘텐츠 -->
        <main class="main-content">
            <!-- 표지 -->
            <section id="cover" class="page-section cover-page">
                <div class="cover-title" contenteditable="true">Monthly Community Review</div>
                <div class="cover-subtitle" contenteditable="true">- Clash Royale</div>
                <div class="cover-version" contenteditable="true">Ver 1.0 <span id="reportDate">2025.07.17</span></div>
                
                <div class="logo-container">
                    <div class="logo-item">
                        <img src="https://i.imgur.com/N2gxrkh.png" alt="Clash Royale" onerror="this.style.display='none'">
                        <div style="margin-top: 8px; font-size: 14px;" contenteditable="true">Clash Royale</div>
                    </div>
                    <div class="logo-item">
                        <img src="https://i.imgur.com/geVZCaY.png" alt="PRABBIT" onerror="this.style.display='none'">
                        <div style="margin-top: 8px; font-size: 14px;" contenteditable="true">PRABBIT</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; font-size: 14px; opacity: 0.8;" contenteditable="true">
                    Community Marketing Team
                </div>
            </section>

            <!-- YouTube 종합 데이터 -->
            <section id="youtube-total" class="page-section">
                <h2 class="page-title" contenteditable="true">📺 클래시 로얄 채널별 데이터 (6월 업로드 콘텐츠)</h2>
                <p class="page-subtitle" contenteditable="true">YouTube 3-month Total Data</p>

                <table class="data-table" id="youtubeMainTable">
                    <thead>
                        <tr>
                            <th rowspan="2">Status</th>
                            <th rowspan="2">Subscriber</th>
                            <th colspan="3">Videos</th>
                            <th colspan="3">Likes</th>
                            <th colspan="3">Community</th>
                        </tr>
                        <tr>
                            <th>Total</th>
                            <th>VOD Views</th>
                            <th>Shorts Views</th>
                            <th>Total</th>
                            <th>VOD Likes</th>
                            <th>Shorts Likes</th>
                            <th>Views</th>
                            <th>Likes</th>
                            <th>Counts</th>
                        </tr>
                    </thead>
                    <tbody id="youtubeMainTableBody">
                        <!-- 데이터가 여기에 동적으로 로드됩니다 -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td style="background: var(--youtube-red); color: white; font-weight: 700;">전월 대비 증감율(%)</td>
                            <td style="background: var(--youtube-red); color: white;">-</td>
                            <td style="background: var(--youtube-red); color: white;" class="positive">41.66%▲</td>
                            <td style="background: var(--youtube-red); color: white;" class="negative">25.36%▼</td>
                            <td style="background: var(--youtube-red); color: white;" class="positive">92.56%▲</td>
                            <td style="background: var(--youtube-red); color: white;" class="positive">26.50%▲</td>
                            <td style="background: var(--youtube-red); color: white;" class="negative">61.26%▼</td>
                            <td style="background: var(--youtube-red); color: white;" class="positive">84.25%▲</td>
                            <td style="background: var(--youtube-red); color: white;" class="negative">30.90%▼</td>
                            <td style="background: var(--youtube-red); color: white;" class="negative">3.59%▼</td>
                            <td style="background: var(--youtube-red); color: white;" class="negative">37.50%▼</td>
                        </tr>
                    </tfoot>
                </table>

                <div class="insights-panel">
                    <div class="insights-title">📊 분석 인사이트</div>
                    <div class="insight-item positive" contenteditable="true">
                        <p>커뮤니티 수치의 하락은 게시물 업로드 수의 하락 때문으로, 평균 수치는 좋아요 10% 증가 / 좋아요 수 54% 증가 / 댓글 수 118% 증가하였음.</p>
                    </div>
                </div>

                <div id="youtube-total-custom-content"></div>
                <div id="youtube-calculated-metrics"></div>
            </section>

            <!-- YouTube 차트 -->
            <section id="youtube-charts" class="page-section">
                <h2 class="page-title" contenteditable="true">📊 클래시 로얄 채널별 데이터 (6월 업로드 콘텐츠)</h2>
                <p class="page-subtitle" contenteditable="true">YouTube 3-month Table & Graph</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                    <div class="chart-container">
                        <div class="chart-title">총 조회수 & 총 좋아요 수</div>
                        <div class="chart-wrapper">
                            <canvas id="youtubeViewsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">업로드 영상 수 & 쇼츠 수</div>
                        <div class="chart-wrapper">
                            <canvas id="youtubeUploadsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-panel">
                    <div class="insights-title">📈 차트 분석</div>
                    <div class="insight-item" contenteditable="true">
                        <p>영상 업로드 수는 줄어들었지만 평균 조회수가 상승함에 따라 전체 조회수가 41% 상승하였음.</p>
                    </div>
                    <div class="insight-item positive" contenteditable="true">
                        <p>또한, 신규 영상들의 국내 시청자 도달률이 90% 중후반대로 소폭 상승하여 유지되고 있음.</p>
                    </div>
                </div>

                <div id="youtube-charts-custom-content"></div>
            </section>

            <!-- YouTube 상세 데이터 -->
            <section id="youtube-detail" class="page-section">
                <h2 class="page-title" contenteditable="true">🎬 클래시 로얄 콘텐츠 데이터</h2>
                <p class="page-subtitle" contenteditable="true">Top 3 Featured Content</p>

                <div class="video-grid" id="topVideosGrid">
                    <!-- 상위 3개 영상이 여기에 동적으로 로드됩니다 -->
                </div>

                <div class="insights-panel">
                    <div class="insights-title">🎯 콘텐츠 성과 분석</div>
                    <div class="insight-item positive" contenteditable="true">
                        <p>VOD 평균 조회수 (22,167회 → 41,291회), Shorts 평균 조회수 (24,312회 → 35,112회)로 상승함.</p>
                    </div>
                    <div class="insight-item" contenteditable="true">
                        <p>특히, VOD의 경우 업로드 영상 수는 줄었지만 TV 로얄 영상이 7만 회의 조회수를 기록하며 평균 조회수가 크게 상승함.</p>
                    </div>
                </div>

                <div id="youtube-detail-custom-content"></div>
                <div id="youtube-detail-calculated-metrics"></div>
            </section>

            <!-- Naver Cafe 종합 -->
            <section id="naver-total" class="page-section">
                <h2 class="page-title" contenteditable="true">💬 클래시 로얄 채널별 데이터</h2>
                <p class="page-subtitle" contenteditable="true">Naver Cafe 3-month total</p>

                <table class="data-table naver" id="naverMainTable">
                    <thead>
                        <tr>
                            <th rowspan="2">Status</th>
                            <th rowspan="2">Join<br>(회원가입)</th>
                            <th colspan="2">Contents (게시물 분석)</th>
                            <th colspan="4">Visitor (방문 분석)</th>
                        </tr>
                        <tr>
                            <th>작성 게시글 수</th>
                            <th>총 조회수</th>
                            <th>댓글 수</th>
                            <th>순방문자 수</th>
                            <th>평균 방문횟수</th>
                            <th>평균 사용시간</th>
                            <th>재방문율</th>
                        </tr>
                    </thead>
                    <tbody id="naverMainTableBody">
                        <!-- 데이터가 여기에 동적으로 로드됩니다 -->
                    </tbody>
                </table>

                <div class="insights-panel">
                    <div class="insights-title">📊 분석 인사이트</div>
                    <div class="insight-item positive" contenteditable="true">
                        <p>지속적인 성장은 크리에이터의 성장에 많은 영향을 받은 것으로 보이며 (Youtube 및 외부 사이트 유입 ↑), 카페 내 크리에이터 언급량이 상승함(특히 호왕)</p>
                    </div>
                </div>

                <div id="naver-total-custom-content"></div>
                <div id="naver-calculated-metrics"></div>
            </section>

            <!-- Naver Cafe 차트 -->
            <section id="naver-charts" class="page-section">
                <h2 class="page-title" contenteditable="true">📈 클래시 로얄 채널별 데이터</h2>
                <p class="page-subtitle" contenteditable="true">Naver Cafe 3-month Table & Graph</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin: 30px 0;">
                    <div class="chart-container">
                        <div class="chart-title">총 조회수 & 순 방문자 수</div>
                        <div class="chart-wrapper">
                            <canvas id="naverVisitorsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">게시글 수 & 댓글 수</div>
                        <div class="chart-wrapper">
                            <canvas id="naverPostsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-panel">
                    <div class="insights-title">📈 차트 분석</div>
                    <div class="insight-item" contenteditable="true">
                        <p>순 방문자 수는 다소 감소했으나 게시글 수(18.1%▲)와 댓글 수(27.7%▲)가 크게 늘어나며 기존 유저들의 커뮤니티 참여가 활발해짐.</p>
                    </div>
                    <div class="insight-item positive" contenteditable="true">
                        <p>또한, 10대(9.6%▲)와 20대(10.9%▲)의 조회수가 큰 폭으로 상승하며 기존보다 어린 연령대로 주요 활동층이 변화하는 양상을 보임.</p>
                    </div>
                </div>

                <div id="naver-charts-custom-content"></div>
            </section>

            <!-- YouTube 커뮤니티 데이터 추가 -->
            <section id="youtube-community" class="page-section">
                <h2 class="page-title" contenteditable="true">📱 YouTube 커뮤니티</h2>
                <p class="page-subtitle" contenteditable="true">YouTube 커뮤니티 탭 활동 통계</p>
                
                <table class="data-table" id="youtubeCommunityTable">
                    <thead>
                        <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th><th>총계</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div class="insights-panel">
                    <div class="insights-title">📊 분석 인사이트</div>
                    <div class="insight-item" contenteditable="true">
                        <p>YouTube 커뮤니티 탭의 활동은 전반적으로 안정적인 참여를 보이고 있습니다. 게시물 수와 좋아요 수가 꾸준히 유지되고 있으며, 댓글 참여도 활발합니다.</p>
                    </div>
                </div>

                <div id="youtube-community-custom-content"></div>
                <div id="youtube-community-calculated-metrics"></div>
            </section>

            <section id="age-analysis" class="page-section">
                <h2 class="page-title" contenteditable="true">👥 클래시 로얄 플랫폼별 주 연령층</h2>
                <p class="page-subtitle" contenteditable="true">Clash Royale Main age groups by platform</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin: 30px 0;">
                    <div class="chart-container">
                        <div class="chart-title">플랫폼별 연령대 비교</div>
                        <div class="chart-wrapper">
                            <canvas id="ageComparisonChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">월별 연령대 변화 (네이버 카페)</div>
                        <div class="chart-wrapper">
                            <canvas id="ageMonthlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="age-distribution">
                    <div class="age-card">
                        <h4>10대</h4>
                        <div class="value" contenteditable="true">196,418</div>
                        <div class="change positive" contenteditable="true">+9.6%</div>
                    </div>
                    <div class="age-card">
                        <h4>20대</h4>
                        <div class="value" contenteditable="true">153,453</div>
                        <div class="change positive" contenteditable="true">+10.9%</div>
                    </div>
                    <div class="age-card">
                        <h4>30대</h4>
                        <div class="value" contenteditable="true">57,974</div>
                        <div class="change negative" contenteditable="true">-14.2%</div>
                    </div>
                    <div class="age-card">
                        <h4>40대 이상</h4>
                        <div class="value" contenteditable="true">85,007</div>
                        <div class="change neutral" contenteditable="true">-0.5%</div>
                    </div>
                </div>

                <div class="insights-panel">
                    <div class="insights-title">📊 연령층 분석</div>
                    <div class="insight-item" contenteditable="true">
                        <p>네이버 카페 이용자의 약 38%가 10대 초반-후반에 집중되어 있으며, 유튜브는 10대 후반(30%) - 30대 초반(22%) 이용자 비중이 절반 이상을 차지하고 있음.</p>
                    </div>
                    <div class="insight-item positive" contenteditable="true">
                        <p>네이버 카페는 24년 후반 ~ 25년 초반까지 10대 후반 - 20대 초반 위주로 커뮤니티가 형성되어 있었으나, 최근 10대의 비중이 지속적으로 상승하고 있음.</p>
                    </div>
                    <div class="insight-item" contenteditable="true">
                        <p>유튜브는 35세~44세로 다소 높은 이용자 연령대를 보였으나, 최근에는 높은 연령대 비중이 크게 줄고 20대 초반 이용자가 빠르게 증가하는 추세임</p>
                    </div>
                </div>

                <div id="age-analysis-custom-content"></div>
            </section>

            <!-- 주요 이슈 -->
            <section id="key-issues" class="page-section">
                <h2 class="page-title" contenteditable="true">🔑 클래시 로얄 Key issues</h2>
                <p class="page-subtitle" contenteditable="true">Updated Contents (Positives & Negatives)</p>

                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="control-btn ai-issue-button" onclick="generateAIKeyIssues()">✨ AI가 주요 이슈 생성</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin: 30px 0;">
                    <div class="insights-panel">
                        <div class="insights-title">👍 Positives</div>
                        <div class="insight-item positive" contenteditable="true">
                            <p>최근 출시되었던 다른 진화 카드와는 달리, 명확한 장단점 덕분에 준수한 성능+타 진화 카드들의 초기 성능과 비교했을 때 양호한 밸런스로 출시된 것 같다는 평가</p>
                        </div>
                        <div class="insight-item positive" contenteditable="true">
                            <p>필요 엘릭서에 비해 능력의 가치(데미지)가 효율이 좋다는 평가</p>
                        </div>
                        <div class="insight-item positive" contenteditable="true">
                            <p>유사 장르인 전략적 팀 전투(TFT)에 비해 플레이 시간이 짧고 규칙이 단순해서 좋다는 평가</p>
                        </div>
                        <div id="key-issues-positives-custom-content"></div>
                    </div>

                    <div class="insights-panel">
                        <div class="insights-title">👎 Negatives</div>
                        <div class="insight-item negative" contenteditable="true">
                            <p>카운터가 너무 명확한 카드 중 하나라 활용이 한정적이라는 평가</p>
                        </div>
                        <div class="insight-item negative" contenteditable="true">
                            <p>4엘릭서에 2회의 순환 주기라는 점 때문에 능력을 제대로 활용하기 전에 게임이 끝나버린다는 의견</p>
                        </div>
                        <div class="insight-item negative" contenteditable="true">
                            <p>가장 핵심적으로, 본 게임의 카드 레벨이 합체 전술에도 적용되면서 기존 필요한 카드만 레벨을 올려두었던 유저들은 자신의 전략과는 상관 없이 불리한 위치에서 플레이하게 되었음.</p>
                        </div>
                        <div id="key-issues-negatives-custom-content"></div>
                    </div>
                </div>
                <div id="key-issues-custom-content"></div>

                <div style="text-align: center; margin-top: 60px; padding-top: 40px; border-top: 2px solid var(--border);">
                    <h2 style="font-size: 48px; font-weight: 300; color: var(--text-muted); margin-bottom: 20px;" contenteditable="true">E.O.D</h2>
                    <p style="color: var(--text-muted); font-size: 14px;" contenteditable="true">
                        <span id="endDate">2025.07.17</span><br>
                        All rights reserved. PRABBIT. 2025
                    </p>
                </div>
            </section>
        </main>
    </div>

    <!-- 알림 표시 영역 -->
    <div class="notification" id="notification"></div>

    <script>
        // 전역 변수
        let uploadedData = {};
        let chartInstances = {};
        let currentReportDate = new Date();
        let excelProcessor; // Declare globally

        // 샘플 데이터 정의
        const sampleDataTemplates = {
            'youtube-total': {
                headers: ['Status', 'Subscriber', 'Videos', 'VOD Views', 'Shorts Views', 'Total Likes', 'VOD Likes', 'Shorts Likes', 'Community Views', 'Community Likes', 'Community Counts'],
                data: [
                    ['4월', '327,139', '903', '133,167', '105,990', '2,378', '287', '2,091', '120,294', '2,596', '13'],
                    ['5월', '327,807', '668', '256,656', '145,872', '4,812', '1,910', '2,902', '330,596', '5,659', '24'],
                    ['6월', '328,528', '721', '363,577', '280,886', '6,087', '740', '5,347', '228,439', '5,456', '15']
                ]
            },
            'youtube-detail': {
                headers: ['Title', 'Date', 'Views', 'Watch Time', 'Subscribers Gained', 'Avg View Duration', 'Impressions', 'CTR', 'Link', 'Thumbnail'],
                data: [
                    ['안돼애애애 [클래시 로얄]', '6월 15일 (일)', '118,010', '217.3', '62', '0:14', '61,639', '4.3%', 'https://youtube.com/shorts/GVXPALB1_jU', 'https://placehold.co/480x270/cccccc/333333?text=Video1'],
                    ['(자막) 신규 게임 모드?! TV로얄', '6월 29일 (일)', '70,958', '1963.5', '218', '1:39', '247,281', '12.4%', 'https://youtu.be/FL7vvTfWRA0', 'https://placehold.co/480x270/cccccc/333333?text=Video2'],
                    ['(자막) 검 vs 철퇴! [클래시 로얄]', '6월 27일 (금)', '46,354', '204.9', '81', '0:26', '114,358', '12.5%', 'https://youtube.com/shorts/QKdUFN77j3Q', 'https://placehold.co/480x270/cccccc/333333?text=Video3']
                ]
            },
            'naver-cafe': {
                headers: ['Status', 'Join', 'Posts', 'Total Views', 'Comments', 'Unique Visitors', 'Avg Visits', 'Avg Duration', 'Return Rate'],
                data: [
                    ['4월', '207,716', '1,846', '442,284', '5,213', '27,952', '3.9', '2m 52s', '23%'],
                    ['5월', '208,366', '2,009', '500,689', '5,521', '45,861', '2.9', '1m 57s', '16.2%'],
                    ['6월', '209,411', '2,372', '515,864', '7,052', '39,820', '3.3', '47s', '22.7%']
                ]
            },
            'dau': {
                headers: ['Date', 'DAU', 'Platform', 'Region'],
                data: [
                    ['2025-06-01', '18500', 'Mobile', 'Korea'],
                    ['2025-06-02', '19200', 'Mobile', 'Korea'],
                    ['2025-06-03', '21400', 'Mobile', 'Korea'],
                    ['2025-06-04', '22100', 'Mobile', 'Korea'],
                    ['2025-06-05', '20800', 'Mobile', 'Korea']
                ]
            }
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            excelProcessor = new ExcelDataProcessor(); // Initialize here
            setupNavigation();
            setupFileUpload();
            initializeCharts();
            loadInitialData();
            setupPeriodSelectors();
            updateReportDate();
            setupCustomContentModal();
        });

        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.getElementById(targetId).scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                });
            });
        }

        function setupFileUpload() {
            const uploadZone = document.getElementById('fileUploadZone');
            const fileInput = uploadZone.querySelector('input[type="file"]');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (eventName === 'dragover') {
                        this.classList.add('dragover');
                    } else if (eventName === 'dragleave') {
                        this.classList.remove('dragover');
                    } else if (eventName === 'drop') {
                        this.classList.remove('dragover');
                        if (e.dataTransfer.files.length > 0) {
                            handleFileUpload(e.dataTransfer.files[0]);
                        }
                    }
                });
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        function updateUploadInfo() {
            const dataType = document.getElementById('dataTypeSelector').value;
            const uploadInfo = document.getElementById('uploadInfo');
            
            if (!dataType) {
                if (uploadInfo) uploadInfo.style.display = 'none';
                return;
            }
            
            if (uploadInfo) {
                uploadInfo.style.display = 'block';
                const infoTexts = {
                    'youtube-total': '📺 YouTube 월별 종합 데이터: 구독자, 조회수, 좋아요 등 월별 집계 데이터',
                    'youtube-detail': '🎬 YouTube 개별 영상 데이터: 제목, 조회수, 시청시간, 썸네일 등 영상별 상세 정보',
                    'naver-cafe': '💬 Naver Cafe 데이터: 가입자, 게시글, 댓글, 방문자 등 커뮤니티 활동 데이터',
                    'dau': '👥 DAU 데이터: 일별 활성 사용자 수, 플랫폼별 구분 데이터'
                };
                uploadInfo.innerHTML = infoTexts[dataType] || '';
            }
        }

        function downloadSample(type) {
            const template = sampleDataTemplates[type];
            if (!template) return;
            
            const csvContent = [
                template.headers.join(','),
                ...template.data.map(row => row.join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `clash_royale_${type}_sample.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification(`📥 ${type} 샘플 데이터를 다운로드했습니다!`, 'success');
        }

        // Excel 파일 처리를 위한 고급 데이터 처리 클래스
        class ExcelDataProcessor {
            constructor() {
                this.requiredSheets = ['Naver Cafe', 'Youtube', 'Youtube(ALL)', 'Youtube community'];
                this.processedData = {};
                this.missingData = [];
                this.calculatedData = {};
            }

            async processExcelFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { 
                                type: 'array',
                                cellStyles: true,
                                cellFormulas: true,
                                cellDates: true
                            });
                            
                            showNotification('📋 Excel 파일 분석 중...', 'info');
                            
                            const result = await this.analyzeWorkbook(workbook);
                            resolve(result);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('파일 읽기 실패'));
                    reader.readAsArrayBuffer(file);
                });
            }

            async analyzeWorkbook(workbook) {
                const availableSheets = workbook.SheetNames;
                const analysisResult = {
                    availableSheets,
                    processedSheets: {},
                    missingSheets: [],
                    dataQuality: {},
                    calculatedFields: {}
                };

                // 필요한 시트 확인
                this.requiredSheets.forEach(sheetName => {
                    if (!availableSheets.includes(sheetName)) {
                        analysisResult.missingSheets.push(sheetName);
                    }
                });

                // 각 시트 처리
                for (const sheetName of availableSheets) {
                    if (this.requiredSheets.includes(sheetName)) {
                        try {
                            const worksheet = workbook.Sheets[sheetName];
                            const sheetData = await this.processSheet(worksheet, sheetName);
                            analysisResult.processedSheets[sheetName] = sheetData;
                            analysisResult.dataQuality[sheetName] = this.assessDataQuality(sheetData);
                        } catch (error) {
                            console.error(`${sheetName} 시트 처리 오류:`, error);
                            analysisResult.missingSheets.push(`${sheetName} (처리 오류)`);
                        }
                    }
                }

                // 계산 필드 생성
                analysisResult.calculatedFields = this.generateCalculatedFields(analysisResult.processedSheets);
                this.processedData = analysisResult; // Store the full analysis result

                return analysisResult;
            }

            async processSheet(worksheet, sheetName) {
                const rawData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: null,
                    raw: false
                });

                // 빈 행 제거
                const cleanData = rawData.filter(row => 
                    row.some(cell => cell !== null && cell !== undefined && cell.toString().trim() !== '')
                );

                if (cleanData.length === 0) {
                    throw new Error(`${sheetName} 시트가 비어있습니다`);
                }

                // 시트별 특화 처리
                switch (sheetName) {
                    case 'Naver Cafe':
                        return this.processNaverCafeSheet(cleanData);
                    case 'Youtube':
                        return this.processYoutubeSheet(cleanData);
                    case 'Youtube(ALL)':
                        return this.processYoutubeAllSheet(cleanData);
                    case 'Youtube community':
                        return this.processYoutubeCommunitySheet(cleanData);
                    default:
                        return this.processGenericSheet(cleanData);
                }
            }

            processNaverCafeSheet(data) {
                // 헤더 찾기
                let headerRow = -1;
                for (let i = 0; i < Math.min(data.length, 10); i++) {
                    const row = data[i];
                    if (row.some(cell => 
                        cell !== null && cell !== undefined && typeof cell === 'string' && (cell.includes('기간') || cell.includes('조회수') || cell.includes('게시글'))
                    )) {
                        headerRow = i;
                        break;
                    }
                }

                if (headerRow === -1) {
                    throw new Error('Naver Cafe 데이터의 헤더를 찾을 수 없습니다');
                }

                const headers = data[headerRow].map(h => h ? h.toString().trim() : '');
                const processedData = {
                    headers,
                    rows: [],
                    monthlyData: {},
                    ageDistribution: {},
                    calculations: {}
                };

                // 데이터 행 처리
                for (let i = headerRow + 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.every(cell => !cell || (typeof cell === 'string' && cell.trim() === ''))) continue;

                    const rowData = {};
                    headers.forEach((header, index) => {
                        if (header) { // Ensure header is not null/undefined
                            rowData[header] = row[index] !== undefined && row[index] !== null ? row[index] : '';
                        }
                    });

                    processedData.rows.push(rowData);

                    // 월별 데이터 추출
                    const period = rowData['기간'] || rowData['Period'] || rowData['Status'];
                    if (period && (typeof period === 'string' && (period.match(/\d{4}[.\-/]\d{1,2}/) || period.includes('월')))) {
                        processedData.monthlyData[period] = rowData;
                    }
                }

                // 자동 계산
                processedData.calculations = this.calculateNaverMetrics(processedData);
                
                return processedData;
            }

            processYoutubeSheet(data) {
                let headerRow = -1;
                for (let i = 0; i < Math.min(data.length, 10); i++) {
                    const row = data[i];
                    if (row.some(cell => 
                        cell !== null && cell !== undefined && typeof cell === 'string' && (cell.includes('Subscriber') || cell.includes('Views') || cell.includes('구독자'))
                    )) {
                        headerRow = i;
                        break;
                    }
                }

                if (headerRow === -1) {
                    throw new Error('YouTube 데이터의 헤더를 찾을 수 없습니다');
                }

                const headers = data[headerRow].map(h => h ? h.toString().trim() : '');
                const processedData = {
                    headers,
                    rows: [],
                    monthlyData: {},
                    calculations: {}
                };

                for (let i = headerRow + 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.every(cell => !cell || (typeof cell === 'string' && cell.trim() === ''))) continue;

                    const rowData = {};
                    headers.forEach((header, index) => {
                        if (header) { // Ensure header is not null/undefined
                            rowData[header] = this.parseNumericValue(row[index]);
                        }
                    });

                    processedData.rows.push(rowData);

                    // 월별 데이터 식별
                    const status = rowData['Status'] || rowData['기간'] || rowData['Month'];
                    if (status && (typeof status === 'string' && (status.includes('월') || status.match(/\d{1,2}/)))) {
                        processedData.monthlyData[status] = rowData;
                    }
                }

                processedData.calculations = this.calculateYoutubeMetrics(processedData);
                return processedData;
            }

            processYoutubeAllSheet(data) {
                let headerRow = -1;
                for (let i = 0; i < Math.min(data.length, 10); i++) {
                    const row = data[i];
                    if (row.some(cell => 
                        cell !== null && cell !== undefined && typeof cell === 'string' && (cell.includes('Title') || cell.includes('제목') || cell.includes('View') || cell.includes('조회'))
                    )) {
                        headerRow = i;
                        break;
                    }
                }

                if (headerRow === -1) {
                    throw new Error('YouTube(ALL) 데이터의 헤더를 찾을 수 없습니다');
                }

                const headers = data[headerRow].map(h => h ? h.toString().trim() : '');
                const processedData = {
                    headers,
                    rows: [],
                    videoData: [],
                    calculations: {}
                };

                for (let i = headerRow + 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.every(cell => !cell || (typeof cell === 'string' && cell.trim() === ''))) continue;

                    const rowData = {};
                    headers.forEach((header, index) => {
                        if (header) { // Ensure header is not null/undefined
                            const value = row[index];
                            if (header.includes('View') || header.includes('조회수') || 
                                header.includes('Like') || header.includes('좋아요') ||
                                header.includes('Click') || header.includes('클릭')) {
                                rowData[header] = this.parseNumericValue(value);
                            } else {
                                rowData[header] = value !== undefined && value !== null ? value : '';
                            }
                        }
                    });

                    processedData.rows.push(rowData);
                    processedData.videoData.push(rowData);
                }

                processedData.calculations = this.calculateVideoMetrics(processedData);
                return processedData;
            }

            processYoutubeCommunitySheet(data) {
                let headerRow = -1;
                for (let i = 0; i < Math.min(data.length, 10); i++) {
                    const row = data[i];
                    if (row.some(cell => 
                        cell !== null && cell !== undefined && typeof cell === 'string' && (cell.includes('Community') || cell.includes('커뮤니티') || cell.includes('Likes'))
                    )) {
                        headerRow = i;
                        break;
                    }
                }

                if (headerRow === -1) {
                    throw new Error('YouTube Community 데이터의 헤더를 찾을 수 없습니다');
                }

                const headers = data[headerRow].map(h => h ? h.toString().trim() : '');
                const processedData = {
                    headers,
                    rows: [],
                    communityData: {},
                    calculations: {}
                };

                for (let i = headerRow + 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.every(cell => !cell || (typeof cell === 'string' && cell.trim() === ''))) continue;

                    const rowData = {};
                    headers.forEach((header, index) => {
                        if (header) { // Ensure header is not null/undefined
                            rowData[header] = this.parseNumericValue(row[index]);
                        }
                    });

                    processedData.rows.push(rowData);
                }

                processedData.calculations = this.calculateCommunityMetrics(processedData);
                return processedData;
            }

            processGenericSheet(data) {
                if (data.length === 0) return { headers: [], rows: [] };
                
                return {
                    headers: data[0] || [],
                    rows: data.slice(1).map(row => {
                        const rowObj = {};
                        data[0].forEach((header, index) => {
                            if (header) { // Ensure header is not null/undefined
                                rowObj[header] = row[index] !== undefined && row[index] !== null ? row[index] : '';
                            }
                        });
                        return rowObj;
                    })
                };
            }

            parseNumericValue(value) {
                if (value === null || value === undefined || value === '') return 0;
                if (typeof value === 'number') return value;
                
                const strValue = value.toString();
                
                // 퍼센트 처리
                if (strValue.includes('%')) {
                    return parseFloat(strValue.replace(/[%,\s]/g, ''));
                }
                
                // 숫자 추출 (쉼표, 공백 제거)
                const numericMatch = strValue.replace(/[,\s]/g, '').match(/[\d.]+/);
                return numericMatch ? parseFloat(numericMatch[0]) : 0;
            }

            calculateNaverMetrics(data) {
                const calculations = {
                    totalViews: 0,
                    totalPosts: 0,
                    totalComments: 0,
                    totalMembers: 0,
                    averageEngagement: 0,
                    monthlyGrowth: {},
                    missingFields: []
                };

                if (!data.rows || data.rows.length === 0) {
                    calculations.missingFields.push('기본 데이터 없음');
                    return calculations;
                }

                // 필드 매핑 (한글/영어 대응)
                const fieldMap = {
                    views: ['조회수', 'Views', 'Total Views'],
                    posts: ['게시글수', 'Posts', 'Post Count'],
                    comments: ['댓글수', 'Comments', 'Comment Count'],
                    members: ['신규 가입자수', 'Join', 'New Members']
                };

                data.rows.forEach(row => {
                    // 조회수 합계
                    const views = this.findFieldValue(row, fieldMap.views);
                    if (views > 0) calculations.totalViews += views;

                    // 게시글 합계
                    const posts = this.findFieldValue(row, fieldMap.posts);
                    if (posts > 0) calculations.totalPosts += posts;

                    // 댓글 합계
                    const comments = this.findFieldValue(row, fieldMap.comments);
                    if (comments > 0) calculations.totalComments += comments;

                    // 신규 가입자 합계
                    const members = this.findFieldValue(row, fieldMap.members);
                    if (members > 0) calculations.totalMembers += members;
                });

                // 평균 참여도 계산 (댓글/게시글 비율)
                if (calculations.totalPosts > 0) {
                    calculations.averageEngagement = calculations.totalComments / calculations.totalPosts;
                }

                // 누락된 필드 확인
                Object.keys(fieldMap).forEach(key => {
                    const found = data.rows.some(row => 
                        fieldMap[key].some(field => row[field] !== undefined && row[field] !== 0)
                    );
                    if (!found) {
                        calculations.missingFields.push(`${key} 데이터 누락`);
                    }
                });

                return calculations;
            }

            calculateYoutubeMetrics(data) {
                const calculations = {
                    totalSubscribers: 0,
                    totalViews: 0,
                    totalLikes: 0,
                    averageViewsPerVideo: 0,
                    engagementRate: 0,
                    monthlyGrowth: {},
                    missingFields: []
                };

                if (!data.rows || data.rows.length === 0) {
                    calculations.missingFields.push('기본 데이터 없음');
                    return calculations;
                }

                const fieldMap = {
                    subscribers: ['Subscriber', '구독자', 'Subscribers'],
                    vodViews: ['VOD Views', 'VOD 조회수', 'Video Views'],
                    shortsViews: ['Shorts Views', 'Shorts 조회수', 'Short Views'],
                    totalLikes: ['Total Likes', '총 좋아요', 'Likes'],
                    communityViews: ['Community Views', '커뮤니티 조회수'],
                };

                // 최신 월 데이터 우선 사용
                const latestData = data.rows[data.rows.length - 1] || {};

                calculations.totalSubscribers = this.findFieldValue(latestData, fieldMap.subscribers);

                data.rows.forEach(row => {
                    const vodViews = this.findFieldValue(row, fieldMap.vodViews);
                    const shortsViews = this.findFieldValue(row, fieldMap.shortsViews);
                    const likes = this.findFieldValue(row, fieldMap.totalLikes);

                    calculations.totalViews += vodViews + shortsViews;
                    calculations.totalLikes += likes;
                });

                // 참여율 계산 (좋아요/조회수)
                if (calculations.totalViews > 0) {
                    calculations.engagementRate = (calculations.totalLikes / calculations.totalViews) * 100;
                }

                // 월별 성장률 계산
                if (data.rows.length >= 2) {
                    const firstMonth = data.rows[0];
                    const lastMonth = data.rows[data.rows.length - 1];
                    
                    const firstSubs = this.findFieldValue(firstMonth, fieldMap.subscribers);
                    const lastSubs = this.findFieldValue(lastMonth, fieldMap.subscribers);
                    
                    if (firstSubs > 0) {
                        calculations.monthlyGrowth.subscribers = ((lastSubs - firstSubs) / firstSubs * 100).toFixed(1);
                    }
                }

                // 누락 필드 확인
                Object.keys(fieldMap).forEach(key => {
                    const found = data.rows.some(row => 
                        fieldMap[key].some(field => row[field] !== undefined && row[field] !== 0)
                    );
                    if (!found) {
                        calculations.missingFields.push(`${key} 데이터 누락`);
                    }
                });

                return calculations;
            }

            calculateVideoMetrics(data) {
                const calculations = {
                    totalVideos: 0,
                    averageViews: 0,
                    topVideos: [],
                    totalEngagement: 0,
                    missingFields: []
                };

                if (!data.videoData || data.videoData.length === 0) {
                    calculations.missingFields.push('비디오 데이터 없음');
                    return calculations;
                }

                calculations.totalVideos = data.videoData.length;

                const fieldMap = {
                    views: ['Views', '조회수'],
                    likes: ['Likes', '좋아요'],
                    title: ['Title', '제목', 'Video Title'],
                    link: ['Link', '링크', 'URL', 'Video Link'],
                    thumbnail: ['Thumbnail', '썸네일', 'Image']
                };

                let totalViews = 0;
                let totalLikes = 0;

                data.videoData.forEach(video => {
                    const views = this.findFieldValue(video, fieldMap.views);
                    const likes = this.findFieldValue(video, fieldMap.likes);
                    const title = this.findFieldValue(video, fieldMap.title);

                    totalViews += views;
                    totalLikes += likes;

                    // 상위 비디오 수집 (조회수 기준)
                    if (views > 0 && title) {
                        calculations.topVideos.push({
                            title: title,
                            views: views,
                            likes: likes,
                            link: this.findFieldValue(video, fieldMap.link) || '#',
                            thumbnail: this.findFieldValue(video, fieldMap.thumbnail) || `https://placehold.co/480x270/cccccc/333333?text=${encodeURIComponent(title.substring(0, 10))}`
                        });
                    }
                });

                calculations.averageViews = calculations.totalVideos > 0 ? totalViews / calculations.totalVideos : 0;
                calculations.totalEngagement = totalLikes;

                // 상위 비디오 정렬 (조회수 기준)
                calculations.topVideos.sort((a, b) => b.views - a.views);
                calculations.topVideos = calculations.topVideos.slice(0, 10); // 상위 10개만

                return calculations;
            }

            calculateCommunityMetrics(data) {
                const calculations = {
                    totalCommunityViews: 0,
                    totalCommunityLikes: 0,
                    totalCommunityPosts: 0,
                    averageEngagement: 0,
                    missingFields: []
                };

                if (!data.rows || data.rows.length === 0) {
                    calculations.missingFields.push('커뮤니티 데이터 없음');
                    return calculations;
                }

                const fieldMap = {
                    views: ['Community Views', '커뮤니티 조회수', 'Views'],
                    likes: ['Community Likes', '커뮤니티 좋아요', 'Likes'],
                    counts: ['Community Counts', '커뮤니티 개수', 'Posts', 'Count']
                };

                data.rows.forEach(row => {
                    calculations.totalCommunityViews += this.findFieldValue(row, fieldMap.views);
                    calculations.totalCommunityLikes += this.findFieldValue(row, fieldMap.likes);
                    calculations.totalCommunityPosts += this.findFieldValue(row, fieldMap.counts);
                });

                if (calculations.totalCommunityViews > 0) {
                    calculations.averageEngagement = (calculations.totalCommunityLikes / calculations.totalCommunityViews) * 100;
                }

                return calculations;
            }

            findFieldValue(row, possibleFields) {
                for (const field of possibleFields) {
                    if (row[field] !== undefined && row[field] !== null) {
                        return this.parseNumericValue(row[field]);
                    }
                }
                return 0;
            }

            assessDataQuality(sheetData) {
                let quality = 100;
                const issues = [];

                if (!sheetData.rows || sheetData.rows.length === 0) {
                    quality = 0;
                    issues.push('데이터 없음');
                    return { score: quality, issues };
                }

                // 빈 값 비율 검사
                const totalCells = sheetData.rows.length * (sheetData.headers?.length || 0);
                let emptyCells = 0;

                sheetData.rows.forEach(row => {
                    Object.values(row).forEach(value => {
                        if (value === null || value === undefined || value === '') {
                            emptyCells++;
                        }
                    });
                });

                const emptyRatio = emptyCells / totalCells;
                if (emptyRatio > 0.3) {
                    quality -= 30;
                    issues.push('빈 값 과다 (30% 이상)');
                } else if (emptyRatio > 0.1) {
                    quality -= 15;
                    issues.push('빈 값 다수 (10% 이상)');
                }

                // 계산된 메트릭의 누락 확인
                if (sheetData.calculations?.missingFields?.length > 0) {
                    quality -= sheetData.calculations.missingFields.length * 10;
                    issues.push(...sheetData.calculations.missingFields);
                }

                return { 
                    score: Math.max(0, quality), 
                    issues: issues.length > 0 ? issues : ['양호'] 
                };
            }

            generateCalculatedFields(processedSheets) {
                const calculated = {};

                if (processedSheets['Youtube']) {
                    calculated.youtubeGrowth = this.calculateGrowthRates(processedSheets['Youtube']);
                }

                if (processedSheets['Naver Cafe']) {
                    calculated.naverEngagement = this.calculateEngagementMetrics(processedSheets['Naver Cafe']);
                }

                if (processedSheets['Youtube(ALL)']) {
                    calculated.topPerformers = this.identifyTopPerformers(processedSheets['Youtube(ALL)']);
                }

                return calculated;
            }

            calculateGrowthRates(youtubeData) {
                if (!youtubeData.rows || youtubeData.rows.length < 2) return null;

                const growth = {};
                const firstMonth = youtubeData.rows[0];
                const lastMonth = youtubeData.rows[youtubeData.rows.length - 1];

                const fields = ['Subscriber', 'VOD Views', 'Shorts Views', 'Total Likes'];
                fields.forEach(field => {
                    const firstValue = this.parseNumericValue(firstMonth[field]);
                    const lastValue = this.parseNumericValue(lastMonth[field]);
                    
                    if (firstValue > 0) {
                        growth[field] = ((lastValue - firstValue) / firstValue * 100).toFixed(1);
                    }
                });

                return growth;
            }

            calculateEngagementMetrics(naverData) {
                if (!naverData.calculations) return null;
                
                return {
                    postsPerDay: naverData.calculations.totalPosts / 30, // 월 평균
                    commentsPerPost: naverData.calculations.averageEngagement,
                    totalActivity: naverData.calculations.totalPosts + naverData.calculations.totalComments
                };
            }

            identifyTopPerformers(youtubeAllData) {
                if (!youtubeAllData.calculations?.topVideos) return null;

                return {
                    mostViewed: youtubeAllData.calculations.topVideos[0] || null,
                    topThree: youtubeAllData.calculations.topVideos.slice(0, 3)
                };
            }
        }

        // Excel/CSV 파일 업로드 처리 (개선된 버전)
        async function handleFileUpload(file) {
            const fileName = file.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const isCSV = fileName.endsWith('.csv');
            
            if (!isExcel && !isCSV) {
                showNotification('❌ Excel (.xlsx) 또는 CSV 파일만 업로드 가능합니다', 'error');
                return;
            }

            showNotification(`📊 ${isExcel ? 'Excel' : 'CSV'} 파일 분석 중...`, 'info');
            
            try {
                let analysisResult;
                
                if (isExcel) {
                    // Excel 파일 처리
                    analysisResult = await excelProcessor.processExcelFile(file);
                    uploadedData = analysisResult.processedSheets; // Store processed sheets
                    await handleExcelAnalysis(analysisResult);
                } else {
                    // 기존 CSV 처리
                    const dataType = document.getElementById('dataTypeSelector').value;
                    if (!dataType) {
                        showNotification('❌ CSV 파일의 경우 데이터 유형을 선택해주세요', 'error');
                        return;
                    }
                    const csvData = await handleCSVFile(file, dataType);
                    uploadedData[dataType] = csvData; // Store CSV data
                    analyzeDataQuality(csvData); // Analyze quality for CSV
                    showNotification(`✅ ${csvData.length}개 CSV 레코드가 업로드되었습니다!`, 'success');
                }
                
            } catch (error) {
                console.error('파일 처리 오류:', error);
                showNotification(`❌ 파일 처리 오류: ${error.message}`, 'error');
            }
        }

        async function handleExcelAnalysis(analysisResult) {
            displayExcelAnalysisResults(analysisResult);
            
            // 자동으로 데이터 적용
            if (Object.keys(analysisResult.processedSheets).length > 0) {
                await applyExcelDataToReport(analysisResult);
                showNotification('✅ Excel 데이터가 성공적으로 적용되었습니다!', 'success');
            } else {
                showNotification('⚠️ 처리 가능한 시트가 없습니다', 'warning');
            }
        }

        function displayExcelAnalysisResults(result) {
            let resultDiv = document.getElementById('excelAnalysisResult');
            let contentDiv;

            if (!resultDiv) {
                const container = document.querySelector('.admin-content');
                resultDiv = document.createElement('div');
                resultDiv.id = 'excelAnalysisResult';
                resultDiv.style.cssText = `margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--info);`;
                
                const header = document.createElement('h4');
                header.style.marginBottom = '12px';
                header.textContent = '📊 Excel 파일 분석 결과';
                resultDiv.appendChild(header);

                contentDiv = document.createElement('div');
                contentDiv.id = 'analysisContent';
                resultDiv.appendChild(contentDiv);

                container.appendChild(resultDiv);
            } else {
                contentDiv = document.getElementById('analysisContent');
            }
            
            let html = '';
            
            // 사용 가능한 시트
            if (result.availableSheets.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong>✅ 발견된 시트:</strong> ${result.availableSheets.join(', ')}
                </div>`;
            }

            // 처리된 시트
            const processedSheetNames = Object.keys(result.processedSheets);
            if (processedSheetNames.length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong>🔄 처리된 시트:</strong> ${processedSheetNames.join(', ')}
                </div>`;

                // 각 시트별 데이터 품질
                processedSheetNames.forEach(sheetName => {
                    const quality = result.dataQuality[sheetName];
                    const qualityColor = quality.score >= 80 ? 'var(--success)' : 
                                         quality.score >= 60 ? 'var(--warning)' : 'var(--error)';
                    html += `<div style="margin: 8px 0; font-size: 13px;">
                        📋 <strong>${sheetName}</strong>: 
                        <span style="color: ${qualityColor}; font-weight: 600;">${quality.score}점</span>
                        ${quality.issues.length > 0 ? `(${quality.issues.join(', ')})` : ''}
                    </div>`;
                });
            }

            // 누락된 시트
            if (result.missingSheets.length > 0) {
                html += `<div style="margin-bottom: 12px; color: var(--warning);">
                    <strong>⚠️ 누락된 시트:</strong> ${result.missingSheets.join(', ')}
                </div>`;
            }

            // 계산된 필드
            if (result.calculatedFields && Object.keys(result.calculatedFields).length > 0) {
                html += `<div style="margin-bottom: 12px;">
                    <strong>🧮 자동 계산 완료:</strong> 
                    ${Object.keys(result.calculatedFields).join(', ')}
                </div>`;
            }

            contentDiv.innerHTML = html;
        }

        async function applyExcelDataToReport(analysisResult) {
            const { processedSheets } = analysisResult;

            // Naver Cafe 데이터 적용
            if (processedSheets['Naver Cafe']) {
                await applyNaverCafeData(processedSheets['Naver Cafe']);
            } else {
                showDataMissingNotice('naver-total', 'Naver Cafe 기본 데이터가 없습니다');
            }

            // YouTube 데이터 적용
            if (processedSheets['Youtube']) {
                await applyYoutubeData(processedSheets['Youtube']);
            } else {
                showDataMissingNotice('youtube-total', 'YouTube 기본 데이터가 없습니다');
            }

            // YouTube 상세 데이터 적용
            if (processedSheets['Youtube(ALL)']) {
                await applyYoutubeDetailData(processedSheets['Youtube(ALL)']);
            } else {
                showDataMissingNotice('youtube-detail', 'YouTube 상세 영상 데이터가 없습니다');
            }

            // YouTube 커뮤니티 데이터 적용
            if (processedSheets['Youtube community']) {
                await applyYoutubeCommunityData(processedSheets['Youtube community']);
            } else {
                showDataMissingNotice('youtube-community', 'YouTube 커뮤니티 데이터가 없습니다');
            }

            // 차트 업데이트
            updateAllCharts();
        }

        async function applyNaverCafeData(naverData) {
            const tbody = document.getElementById('naverMainTableBody');
            tbody.innerHTML = '';

            const monthlyEntries = Object.entries(naverData.monthlyData).sort();
            
            monthlyEntries.forEach(([period, data]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${period}</strong></td>
                    <td>${formatNumber(excelProcessor.findFieldValue(data, ['Join', '회원가입']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(data, ['Posts', '게시글수']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(data, ['Total Views', '총 조회수', '조회수']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(data, ['Comments', '댓글수']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(data, ['Unique Visitors', '순방문자수']) || 0)}</td>
                    <td>${excelProcessor.findFieldValue(data, ['Avg Visits', '평균방문횟수']) || '0'}</td>
                    <td>${excelProcessor.findFieldValue(data, ['Avg Duration', '평균사용시간']) || '0s'}</td>
                    <td>${excelProcessor.findFieldValue(data, ['Return Rate', '재방문율']) || '0%'}</td>
                `;
                tbody.appendChild(tr);
            });

            updateCalculatedMetrics('naver', naverData.calculations);
        }

        async function applyYoutubeData(youtubeData) {
            const tbody = document.getElementById('youtubeMainTableBody');
            tbody.innerHTML = '';

            youtubeData.rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.Status || row['기간'] || '데이터 없음'}</strong></td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Subscriber', '구독자']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Videos', '영상수']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['VOD Views', 'VOD 조회수']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Shorts Views', 'Shorts 조회수']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Total Likes', '총 좋아요']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['VOD Likes', 'VOD 좋아요']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Shorts Likes', 'Shorts 좋아요']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Community Views', '커뮤니티 조회수']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Community Likes', '커뮤니티 좋아요']) || 0)}</td>
                    <td>${formatNumber(excelProcessor.findFieldValue(row, ['Community Counts', '커뮤니티 개수']) || 0)}</td>
                `;
                tbody.appendChild(tr);
            });

            updateCalculatedMetrics('youtube', youtubeData.calculations);
        }

        async function applyYoutubeDetailData(youtubeAllData) {
            const grid = document.getElementById('topVideosGrid');
            grid.innerHTML = '';
            
            const topVideos = youtubeAllData.calculations.topPerformers?.topThree || [];
            
            if (topVideos.length === 0) {
                showDataMissingNotice('youtube-detail', 'YouTube 상세 영상 데이터가 부족합니다.');
                return;
            }

            topVideos.forEach((video, index) => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.innerHTML = `
                    <img src="${video.thumbnail}" 
                         alt="${video.title}" 
                         class="video-thumbnail"
                         onerror="this.src='https://placehold.co/480x270/cccccc/333333?text=Video${index + 1}'">
                    <div class="video-info">
                        <div class="video-title">${video.title}</div>
                        <div class="video-stats">
                            조회수: ${formatNumber(video.views)} | 
                            좋아요: ${formatNumber(video.likes)}
                        </div>
                        <a href="${video.link}" target="_blank" class="video-link">영상 보기</a>
                    </div>
                `;
                grid.appendChild(card);
            });

            updateCalculatedMetrics('youtube-detail', youtubeAllData.calculations);
        }

        async function applyYoutubeCommunityData(communityData) {
            const tbody = document.getElementById('youtubeCommunityTable').querySelector('tbody');
            tbody.innerHTML = '';

            const items = ['게시물 수', '좋아요 수', '댓글 수']; // Example items, adjust based on actual data
            const months = ['4월', '5월', '6월']; // Example months, adjust dynamically if needed

            // Assuming communityData.rows contains data for each month
            // Example:
            // { 'Community Counts': 13, 'Community Likes': 2596, 'Community Views': 120294 } for '4월'
            // Need to map these to the table structure
            
            const communityRows = {
                '게시물 수': {},
                '좋아요 수': {},
                '댓글 수': {}
            };

            communityData.rows.forEach(row => {
                const status = row.Status || row['기간'] || '월';
                communityRows['게시물 수'][status] = excelProcessor.findFieldValue(row, ['Community Counts', '커뮤니티 개수']);
                communityRows['좋아요 수'][status] = excelProcessor.findFieldValue(row, ['Community Likes', '커뮤니티 좋아요']);
                communityRows['댓글 수'][status] = excelProcessor.findFieldValue(row, ['Community Comments', '커뮤니티 댓글']); // Assuming there's a comments field
            });

            items.forEach(item => {
                const tr = document.createElement('tr');
                let rowHtml = `<td><strong>${item}</strong></td>`;
                let total = 0;
                months.forEach(month => {
                    const value = communityRows[item][month] || 0;
                    rowHtml += `<td>${formatNumber(value)}</td>`;
                    total += value;
                });
                rowHtml += `<td><strong>${formatNumber(total)}</strong></td>`;
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });

            updateCalculatedMetrics('youtube-community', communityData.calculations);
        }


        function showDataMissingNotice(sectionId, message) {
            const section = document.getElementById(sectionId);
            if (section) {
                const notice = document.createElement('div');
                notice.className = 'data-missing-notice';
                notice.style.cssText = `
                    background: #fef3cd; 
                    border: 1px solid #ffeaa7; 
                    border-radius: 8px; 
                    padding: 16px; 
                    margin: 16px 0; 
                    color: #856404;
                    text-align: center;
                `;
                notice.innerHTML = `
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">⚠️ 데이터 누락</div>
                    <div style="font-size: 13px;">${message}</div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                        Excel 파일에 해당 시트의 데이터를 추가해주세요
                    </div>
                `;
                
                // 기존 누락 알림 제거 후 새로 추가
                const existingNotice = section.querySelector('.data-missing-notice');
                if (existingNotice) existingNotice.remove();
                
                section.appendChild(notice);
            }
        }

        function updateCalculatedMetrics(type, calculations) {
            if (!calculations) return;

            // 계산된 지표를 UI에 표시
            const metricsDisplay = document.getElementById(`${type}-calculated-metrics`);
            if (metricsDisplay) {
                let html = '<div style="margin: 16px 0; padding: 12px; background: #e8f5e8; border-radius: 8px;">';
                html += '<h5 style="margin-bottom: 8px;">🧮 자동 계산된 지표</h5>';
                
                Object.entries(calculations).forEach(([key, value]) => {
                    if (key !== 'missingFields' && value !== null && value !== undefined) {
                        html += `<div style="font-size: 13px; margin: 4px 0;">
                            <strong>${key}:</strong> ${typeof value === 'number' ? formatNumber(value) : value}
                        </div>`;
                    }
                });
                
                if (calculations.missingFields && calculations.missingFields.length > 0) {
                    html += `<div style="margin-top: 8px; font-size: 12px; color: var(--warning);">
                        <strong>누락 필드:</strong> ${calculations.missingFields.join(', ')}
                    </div>`;
                }
                
                html += '</div>';
                metricsDisplay.innerHTML = html;
            }
        }

        async function handleCSVFile(file, dataType) {
            const reader = new FileReader();
            
            return new Promise((resolve, reject) => {
                reader.onload = function(e) {
                    Papa.parse(e.target.result, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                reject(new Error('CSV 파싱 오류: ' + results.errors[0].message));
                                return;
                            }
                            
                            uploadedData[dataType] = results.data;
                            analyzeDataQuality(results.data);
                            showNotification(`✅ ${results.data.length}개 CSV 레코드가 업로드되었습니다!`, 'success');
                            resolve(results.data);
                        },
                        error: function(error) {
                            reject(new Error('파일 읽기 오류: ' + error.message));
                        }
                    });
                };
                reader.onerror = () => reject(new Error('파일 읽기 실패'));
                reader.readAsText(file, 'utf-8');
            });
        }

        function analyzeDataQuality(data) {
            if (!data || data.length === 0) {
                updateQualityDisplay(0, '데이터 없음');
                return;
            }
            
            let quality = 100;
            const issues = [];
            
            // 결측치 검사
            let missingCount = 0;
            const totalCells = data.length * Object.keys(data[0]).length;
            
            data.forEach(row => {
                Object.values(row).forEach(value => {
                    if (value === null || value === undefined || value === '') {
                        missingCount++;
                    }
                });
            });
            
            const missingRate = missingCount / totalCells;
            if (missingRate > 0.1) {
                quality -= 20;
                issues.push('결측치 다수');
            }
            
            // 데이터 일관성 검사
            const headers = Object.keys(data[0]);
            let inconsistentCols = 0;
            
            headers.forEach(header => {
                const types = new Set();
                data.slice(0, 10).forEach(row => {
                    if (row[header] !== null && row[header] !== undefined) {
                        types.add(typeof row[header]);
                    }
                });
                if (types.size > 1) inconsistentCols++;
            });
            
            if (inconsistentCols > headers.length * 0.2) {
                quality -= 15;
                issues.push('타입 불일치');
            }
            
            quality = Math.max(0, quality);
            const status = quality >= 90 ? '최우수' : 
                           quality >= 80 ? '우수' : 
                           quality >= 70 ? '양호' : 
                           quality >= 60 ? '보통' : '개선필요';
            
            updateQualityDisplay(quality, status, issues);
        }

        function updateQualityDisplay(score, status, issues = []) {
            const infoDiv = document.getElementById('dataQualityInfo');
            const bar = document.getElementById('qualityBar');
            const text = document.getElementById('qualityText');
            
            infoDiv.style.display = 'block';
            bar.style.width = score + '%';
            
            if (score >= 80) bar.style.background = 'var(--success)';
            else if (score >= 60) bar.style.background = 'var(--warning)';
            else bar.style.background = 'var(--error)';
            
            text.textContent = `품질 점수: ${score.toFixed(0)}% (${status})`;
            if (issues.length > 0) {
                text.textContent += ` - 이슈: ${issues.join(', ')}`;
            }
        }

        function processUploadedData() {
            if (Object.keys(uploadedData).length === 0) {
                showNotification('❌ 업로드된 데이터가 없습니다', 'error');
                return;
            }
            
            showNotification('🔄 데이터를 처리하고 있습니다...', 'info');
            
            setTimeout(() => {
                // Assuming excelProcessor.processedData holds the full analysis result
                if (excelProcessor.processedData && Object.keys(excelProcessor.processedData.processedSheets).length > 0) {
                    applyExcelDataToReport(excelProcessor.processedData);
                } else {
                    // Fallback for CSV or if Excel processing failed to populate processedSheets
                    if (uploadedData['youtube-total']) {
                        updateYouTubeMainTable(uploadedData['youtube-total']);
                    }
                    if (uploadedData['youtube-detail']) {
                        updateYouTubeDetailSection(uploadedData['youtube-detail']);
                    }
                    if (uploadedData['naver-cafe']) {
                        updateNaverMainTable(uploadedData['naver-cafe']);
                    }
                    if (uploadedData['youtube-community']) {
                        applyYoutubeCommunityData(uploadedData['youtube-community']);
                    }
                }
                
                updateAllCharts();
                
                showNotification('✅ 모든 데이터가 성공적으로 적용되었습니다!', 'success');
                closeAdminPanel();
            }, 1500);
        }

        function updateYouTubeMainTable(data) {
            const tbody = document.getElementById('youtubeMainTableBody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.Status || row['Status'] || ''}</strong></td>
                    <td>${formatNumber(row.Subscriber || row['구독자'] || 0)}</td>
                    <td>${formatNumber(row.Videos || row['영상수'] || 0)}</td>
                    <td>${formatNumber(row['VOD Views'] || row['VOD 조회수'] || 0)}</td>
                    <td>${formatNumber(row['Shorts Views'] || row['Shorts 조회수'] || 0)}</td>
                    <td>${formatNumber(row['Total Likes'] || row['총 좋아요'] || 0)}</td>
                    <td>${formatNumber(row['VOD Likes'] || row['VOD 좋아요'] || 0)}</td>
                    <td>${formatNumber(row['Shorts Likes'] || row['Shorts 좋아요'] || 0)}</td>
                    <td>${formatNumber(row['Community Views'] || row['커뮤니티 조회수'] || 0)}</td>
                    <td>${formatNumber(row['Community Likes'] || row['커뮤니티 좋아요'] || 0)}</td>
                    <td>${formatNumber(row['Community Counts'] || row['커뮤니티 개수'] || 0)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateYouTubeDetailSection(data) {
            const grid = document.getElementById('topVideosGrid');
            grid.innerHTML = '';
            
            // 조회수 기준 상위 3개 선택
            const sortedTopVideos = data
                .sort((a, b) => (parseFloat(b.Views || b['조회수'] || 0)) - (parseFloat(a.Views || a['조회수'] || 0)))
                .slice(0, 3);

            if (sortedTopVideos.length === 0) {
                showDataMissingNotice('youtube-detail', 'YouTube 상세 영상 데이터가 부족합니다.');
                return;
            }

            sortedTopVideos.forEach((video, index) => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.innerHTML = `
                    <img src="${video.Thumbnail || video['썸네일'] || 'https://placehold.co/480x270/cccccc/333333?text=Video' + (index + 1)}" 
                         alt="${video.Title || video['제목'] || ''}" 
                         class="video-thumbnail"
                         onerror="this.src='https://placehold.co/480x270/cccccc/333333?text=Video${index + 1}'">
                    <div class="video-info">
                        <div class="video-title">${video.Title || video['제목'] || ''}</div>
                        <div class="video-stats">
                            조회수: ${formatNumber(video.Views || video['조회수'] || 0)} | 
                            좋아요: ${formatNumber(video.Likes || video['좋아요'] || 0)}
                        </div>
                        <a href="${video.Link || video['링크'] || '#'}" target="_blank" class="video-link">영상 보기</a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function updateNaverMainTable(data) {
            const tbody = document.getElementById('naverMainTableBody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.Status || row['기간'] || ''}</strong></td>
                    <td>${formatNumber(row.Join || row['회원가입'] || 0)}</td>
                    <td>${formatNumber(row.Posts || row['게시글'] || 0)}</td>
                    <td>${formatNumber(row['Total Views'] || row['총조회수'] || 0)}</td>
                    <td>${formatNumber(row.Comments || row['댓글'] || 0)}</td>
                    <td>${formatNumber(row['Unique Visitors'] || row['순방문자'] || 0)}</td>
                    <td>${row['Avg Visits'] || row['평균방문'] || 0}</td>
                    <td>${row['Avg Duration'] || row['평균시간'] || '0s'}</td>
                    <td>${row['Return Rate'] || row['재방문율'] || '0%'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function initializeCharts() {
            Chart.defaults.font.family = "'Segoe UI', sans-serif";
            Chart.defaults.plugins.legend.position = 'bottom';
        }

        function updateAllCharts() {
            updateYouTubeCharts();
            updateNaverCharts();
            updateAgeCharts();
        }

        function updateYouTubeCharts() {
            // YouTube 조회수 차트
            const ctx1 = document.getElementById('youtubeViewsChart');
            if (ctx1) {
                if (chartInstances.youtubeViews) chartInstances.youtubeViews.destroy();
                
                // Use data from uploadedData if available, otherwise use sample
                const youtubeData = uploadedData['Youtube']?.rows || sampleDataTemplates['youtube-total'].data.map(row => ({
                    Status: row[0],
                    'VOD Views': excelProcessor.parseNumericValue(row[3]),
                    'Shorts Views': excelProcessor.parseNumericValue(row[4]),
                    'Total Likes': excelProcessor.parseNumericValue(row[5])
                }));

                const labels = youtubeData.map(row => row.Status || row['기간'] || row['Month']);
                const totalViews = youtubeData.map(row => (row['VOD Views'] || 0) + (row['Shorts Views'] || 0));
                const totalLikes = youtubeData.map(row => row['Total Likes'] || 0);

                chartInstances.youtubeViews = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '총 조회수',
                            data: totalViews,
                            backgroundColor: 'rgba(255, 0, 0, 0.8)',
                            borderColor: 'rgba(255, 0, 0, 1)',
                            borderWidth: 1
                        }, {
                            label: '총 좋아요',
                            data: totalLikes,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // YouTube 업로드 차트
            const ctx2 = document.getElementById('youtubeUploadsChart');
            if (ctx2) {
                if (chartInstances.youtubeUploads) chartInstances.youtubeUploads.destroy();
                
                const youtubeData = uploadedData['Youtube']?.rows || sampleDataTemplates['youtube-total'].data.map(row => ({
                    Status: row[0],
                    Videos: excelProcessor.parseNumericValue(row[2]) // Total videos
                }));

                const labels = youtubeData.map(row => row.Status || row['기간'] || row['Month']);
                const videoCounts = youtubeData.map(row => row.Videos || 0);
                // Assuming shorts count is not directly available in 'Youtube' sheet,
                // if it's in 'Youtube(ALL)', we'd need to process that. For now, use a placeholder or derive if possible.
                // For this example, I'll use a simplified placeholder for shorts or derive from 'Youtube(ALL)' if available.
                // For simplicity, let's assume 'Shorts Views' can imply shorts count for now, or use a fixed sample.
                const shortsCounts = youtubeData.map(row => excelProcessor.parseNumericValue(row['Shorts Views'] || 0) > 0 ? 1 : 0); // Simplified: if shorts views > 0, count as 1 short video
                // A better approach would be to count distinct shorts from Youtube(ALL) if available.
                // For now, let's use a sample for shorts count if no direct data.
                const sampleShortsData = [4, 6, 8]; // Example placeholder

                chartInstances.youtubeUploads = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '업로드 영상 수',
                            data: videoCounts,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '업로드 쇼츠 수',
                            data: sampleShortsData, // Using sample for now, needs actual data if available
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateNaverCharts() {
            // Naver 방문자 차트
            const ctx1 = document.getElementById('naverVisitorsChart');
            if (ctx1) {
                if (chartInstances.naverVisitors) chartInstances.naverVisitors.destroy();
                
                const naverData = uploadedData['Naver Cafe']?.rows || sampleDataTemplates['naver-cafe'].data.map(row => ({
                    Status: row[0],
                    'Total Views': excelProcessor.parseNumericValue(row[3]),
                    'Unique Visitors': excelProcessor.parseNumericValue(row[5])
                }));

                const labels = naverData.map(row => row.Status || row['기간']);
                const totalViews = naverData.map(row => row['Total Views'] || 0);
                const uniqueVisitors = naverData.map(row => row['Unique Visitors'] || 0);

                chartInstances.naverVisitors = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '총 조회수',
                            data: totalViews,
                            backgroundColor: 'rgba(0, 199, 60, 0.8)',
                            borderColor: 'rgba(0, 199, 60, 1)',
                            borderWidth: 1
                        }, {
                            label: '순 방문자 수',
                            data: uniqueVisitors,
                            backgroundColor: 'rgba(0, 150, 45, 0.8)',
                            borderColor: 'rgba(0, 150, 45, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Naver 게시글 차트
            const ctx2 = document.getElementById('naverPostsChart');
            if (ctx2) {
                if (chartInstances.naverPosts) chartInstances.naverPosts.destroy();
                
                const naverData = uploadedData['Naver Cafe']?.rows || sampleDataTemplates['naver-cafe'].data.map(row => ({
                    Status: row[0],
                    Posts: excelProcessor.parseNumericValue(row[2]),
                    Comments: excelProcessor.parseNumericValue(row[4])
                }));

                const labels = naverData.map(row => row.Status || row['기간']);
                const posts = naverData.map(row => row.Posts || 0);
                const comments = naverData.map(row => row.Comments || 0);

                chartInstances.naverPosts = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '게시글 수',
                            data: posts,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: '댓글 수',
                            data: comments,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateAgeCharts() {
            // 연령대 비교 차트 (Using hardcoded sample for now, as DAU sheet doesn't have age breakdown)
            const ctx1 = document.getElementById('ageComparisonChart');
            if (ctx1) {
                if (chartInstances.ageComparison) chartInstances.ageComparison.destroy();
                
                chartInstances.ageComparison = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['10대', '20대', '30대', '40대+'],
                        datasets: [{
                            label: '네이버 카페',
                            data: [196418, 153453, 57974, 85007],
                            backgroundColor: 'rgba(0, 199, 60, 0.8)'
                        }, {
                            label: 'YouTube',
                            data: [142244, 131712, 51782, 80187],
                            backgroundColor: 'rgba(255, 0, 0, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // 연령대 월별 변화 차트 (Using hardcoded sample for now)
            const ctx2 = document.getElementById('ageMonthlyChart');
            if (ctx2) {
                if (chartInstances.ageMonthly) chartInstances.ageMonthly.destroy();
                
                chartInstances.ageMonthly = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: ['4월', '5월', '6월'],
                        datasets: [{
                            label: '10대',
                            data: [160618, 179263, 196418],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '20대',
                            data: [131712, 138393, 153453],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '30대',
                            data: [51782, 67609, 57974],
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '40대+',
                            data: [80187, 85410, 85007],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function loadInitialData() {
            // Initial data load for tables
            const defaultYouTubeData = sampleDataTemplates['youtube-total'].data.map(row => ({
                Status: row[0], Subscriber: excelProcessor.parseNumericValue(row[1]), Videos: excelProcessor.parseNumericValue(row[2]), 
                'VOD Views': excelProcessor.parseNumericValue(row[3]), 'Shorts Views': excelProcessor.parseNumericValue(row[4]), 
                'Total Likes': excelProcessor.parseNumericValue(row[5]), 'VOD Likes': excelProcessor.parseNumericValue(row[6]), 
                'Shorts Likes': excelProcessor.parseNumericValue(row[7]), 'Community Views': excelProcessor.parseNumericValue(row[8]), 
                'Community Likes': excelProcessor.parseNumericValue(row[9]), 'Community Counts': excelProcessor.parseNumericValue(row[10])
            }));
            updateYouTubeMainTable(defaultYouTubeData);
            
            const defaultNaverData = sampleDataTemplates['naver-cafe'].data.map(row => ({
                Status: row[0], Join: excelProcessor.parseNumericValue(row[1]), Posts: excelProcessor.parseNumericValue(row[2]), 
                'Total Views': excelProcessor.parseNumericValue(row[3]), Comments: excelProcessor.parseNumericValue(row[4]), 
                'Unique Visitors': excelProcessor.parseNumericValue(row[5]), 'Avg Visits': row[6], 
                'Avg Duration': row[7], 'Return Rate': row[8]
            }));
            updateNaverMainTable(defaultNaverData);
            
            const defaultYouTubeDetail = sampleDataTemplates['youtube-detail'].data.map(row => ({
                Title: row[0], Views: excelProcessor.parseNumericValue(row[2]), Likes: excelProcessor.parseNumericValue(row[5]), 
                Link: row[8], Thumbnail: row[9]
            }));
            updateYouTubeDetailSection(defaultYouTubeDetail);

            // Default community data for the table
            const defaultCommunityData = {
                rows: [
                    { Status: '4월', 'Community Counts': 13, 'Community Likes': 2596, 'Community Views': 120294, 'Community Comments': 100 },
                    { Status: '5월', 'Community Counts': 24, 'Community Likes': 5659, 'Community Views': 330596, 'Community Comments': 200 },
                    { Status: '6월', 'Community Counts': 15, 'Community Likes': 5456, 'Community Views': 228439, 'Community Comments': 150 }
                ],
                calculations: {
                    totalCommunityViews: 679329,
                    totalCommunityLikes: 13711,
                    totalCommunityPosts: 52,
                    averageEngagement: 2.018,
                    missingFields: []
                }
            };
            applyYoutubeCommunityData(defaultCommunityData);

            updateAllCharts(); // Update charts with default data
        }

        function formatNumber(num) {
            if (typeof num === 'string') {
                num = parseFloat(num.replace(/[,]/g, '')) || 0;
            }
            return new Intl.NumberFormat('ko-KR').format(num);
        }

        function setupPeriodSelectors() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1; // getMonth() is 0-indexed

            for (let i = currentYear - 2; i <= currentYear + 1; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}년`;
                yearSelector.appendChild(option);
            }

            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}월`;
                monthSelector.appendChild(option);
            }

            yearSelector.value = currentYear;
            monthSelector.value = currentMonth;

            yearSelector.addEventListener('change', updateReportDate);
            monthSelector.addEventListener('change', updateReportDate);
            updateReportDate(); // Initial call
        }

        function updateReportDate() {
            const year = document.getElementById('yearSelector').value;
            const month = document.getElementById('monthSelector').value;
            currentReportDate = new Date(year, month - 1, 1); // Month is 0-indexed for Date object

            const formattedDate = `${year}년 ${month}월`;
            document.getElementById('currentPeriod').textContent = formattedDate;

            const dateStr = currentReportDate.toISOString().split('T')[0].replace(/-/g, '.');
            document.getElementById('reportDate').textContent = dateStr;
            document.getElementById('endDate').textContent = dateStr;
        }

        function generateReport() {
            showNotification('📄 리포트를 생성 중입니다...', 'info');
            setTimeout(() => {
                showNotification('✅ 리포트가 생성되었습니다!', 'success');
            }, 2000);
        }

        function exportToPDF() {
            showNotification('📥 PDF를 생성 중입니다...', 'info');
            
            const element = document.querySelector('.main-content');
            const opt = {
                margin: 1,
                filename: `clash_royale_monthly_review_${currentReportDate.toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                showNotification('✅ PDF가 성공적으로 생성되었습니다!', 'success');
            });
        }

        function openAdminPanel() {
            document.getElementById('adminModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAdminPanel() {
            document.getElementById('adminModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Custom Content Features
        function setupCustomContentModal() {
            const contentTypeSelector = document.getElementById('contentTypeSelector');
            contentTypeSelector.addEventListener('change', function() {
                document.getElementById('textInputGroup').style.display = 'none';
                document.getElementById('imageInputGroup').style.display = 'none';
                if (this.value === 'text') {
                    document.getElementById('textInputGroup').style.display = 'block';
                } else if (this.value === 'image') {
                    document.getElementById('imageInputGroup').style.display = 'block';
                }
            });
        }

        function openAddCustomContentModal() {
            document.getElementById('addCustomContentModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            // Reset form
            document.getElementById('customContentText').value = '';
            document.getElementById('customContentImageUrl').value = '';
            document.getElementById('customContentImageAlt').value = '';
            document.getElementById('contentTypeSelector').value = 'text';
            document.getElementById('textInputGroup').style.display = 'block';
            document.getElementById('imageInputGroup').style.display = 'none';
        }

        function closeAddCustomContentModal() {
            document.getElementById('addCustomContentModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function addCustomContent() {
            const sectionId = document.getElementById('contentSectionSelector').value;
            const contentType = document.getElementById('contentTypeSelector').value;
            const targetSection = document.getElementById(`${sectionId}-custom-content`);

            if (!targetSection) {
                showNotification('❌ 선택된 섹션을 찾을 수 없습니다.', 'error');
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'editable-content-wrapper';
            wrapper.innerHTML = `
                <div class="content-header">
                    <span>${contentType === 'text' ? '사용자 정의 텍스트' : '사용자 정의 이미지'}</span>
                    <button onclick="this.closest('.editable-content-wrapper').remove()">&#x2715;</button>
                </div>
            `;

            if (contentType === 'text') {
                const text = document.getElementById('customContentText').value;
                const textBlock = document.createElement('div');
                textBlock.className = 'editable-text-block';
                textBlock.contentEditable = true;
                textBlock.innerHTML = text || '클릭하여 텍스트를 입력하세요...';
                wrapper.appendChild(textBlock);
            } else if (contentType === 'image') {
                const imageUrl = document.getElementById('customContentImageUrl').value;
                const imageAlt = document.getElementById('customContentImageAlt').value;
                const imageBlock = document.createElement('div');
                imageBlock.className = 'editable-image-block';
                imageBlock.innerHTML = `
                    <img src="${imageUrl || 'https://placehold.co/300x200?text=No+Image'}" alt="${imageAlt || '사용자 정의 이미지'}">
                    <input type="text" value="${imageUrl}" placeholder="이미지 URL" onchange="this.previousElementSibling.src=this.value || 'https://placehold.co/300x200?text=No+Image'">
                    <input type="text" value="${imageAlt}" placeholder="이미지 설명" onchange="this.previousElementSibling.previousElementSibling.alt=this.value">
                `;
                wrapper.appendChild(imageBlock);
            }

            targetSection.appendChild(wrapper);
            showNotification('✅ 커스텀 콘텐츠가 추가되었습니다!', 'success');
            closeAddCustomContentModal();
        }

        // AI Key Issues Generation
        async function generateAIKeyIssues() {
            showNotification('✨ AI가 주요 이슈를 분석 중입니다...', 'info');
            const positiveIssuesDiv = document.querySelector('#key-issues .insights-panel:first-of-type');
            const negativeIssuesDiv = document.querySelector('#key-issues .insights-panel:last-of-type');

            // Clear existing AI-generated content (keep manual edits)
            positiveIssuesDiv.querySelectorAll('.insight-item:not([contenteditable="true"])').forEach(el => el.remove());
            negativeIssuesDiv.querySelectorAll('.insight-item:not([contenteditable="true"])').forEach(el => el.remove());

            // Prepare prompt based on available data
            let prompt = "클래시 로얄 월간 커뮤니티 리뷰 데이터를 기반으로 주요 긍정적 이슈와 부정적 이슈를 각각 3~5가지씩 요약해줘. 데이터는 다음과 같아:\n\n";
            
            if (excelProcessor.processedData) {
                const sheets = excelProcessor.processedData.processedSheets;
                const calcs = excelProcessor.processedData.calculatedFields;

                if (sheets['Youtube']) {
                    prompt += "--- YouTube 종합 데이터 ---\n";
                    sheets['Youtube'].rows.forEach(row => {
                        prompt += `월: ${row.Status || 'N/A'}, 구독자: ${row.Subscriber || 'N/A'}, 총 조회수: ${excelProcessor.findFieldValue(row, ['VOD Views', 'Shorts Views']) || 'N/A'}, 총 좋아요: ${row['Total Likes'] || 'N/A'}\n`;
                    });
                    if (calcs.youtubeGrowth) {
                        prompt += `구독자 성장률: ${calcs.youtubeGrowth.Subscriber || 'N/A'}%\n`;
                    }
                    prompt += "\n";
                }

                if (sheets['Youtube(ALL)']) {
                    prompt += "--- YouTube 상세 영상 데이터 (상위 3개) ---\n";
                    (calcs.topPerformers?.topThree || []).forEach(video => {
                        prompt += `제목: ${video.title}, 조회수: ${video.views}, 좋아요: ${video.likes}\n`;
                    });
                    prompt += `평균 VOD 조회수: ${calcs.averageViewsPerVideo || 'N/A'}\n`;
                    prompt += "\n";
                }

                if (sheets['Naver Cafe']) {
                    prompt += "--- Naver Cafe 종합 데이터 ---\n";
                    sheets['Naver Cafe'].rows.forEach(row => {
                        prompt += `월: ${row.Status || 'N/A'}, 게시글 수: ${excelProcessor.findFieldValue(row, ['Posts', '게시글수']) || 'N/A'}, 총 조회수: ${excelProcessor.findFieldValue(row, ['Total Views', '조회수']) || 'N/A'}, 댓글 수: ${excelProcessor.findFieldValue(row, ['Comments', '댓글수']) || 'N/A'}, 순방문자 수: ${excelProcessor.findFieldValue(row, ['Unique Visitors', '순방문자수']) || 'N/A'}\n`;
                    });
                    if (calcs.naverEngagement) {
                        prompt += `게시물당 평균 댓글: ${calcs.naverEngagement.commentsPerPost || 'N/A'}\n`;
                    }
                    prompt += "\n";
                }

                if (sheets['Youtube community']) {
                    prompt += "--- YouTube 커뮤니티 데이터 ---\n";
                    sheets['Youtube community'].rows.forEach(row => {
                        prompt += `월: ${row.Status || 'N/A'}, 커뮤니티 게시물: ${excelProcessor.findFieldValue(row, ['Community Counts']) || 'N/A'}, 좋아요: ${excelProcessor.findFieldValue(row, ['Community Likes']) || 'N/A'}, 조회수: ${excelProcessor.findFieldValue(row, ['Community Views']) || 'N/A'}\n`;
                    });
                    prompt += "\n";
                }

                // Add age analysis insights if available (currently hardcoded, but if dynamic, add here)
                prompt += "--- 연령층 분석 (현재 데이터 기반) ---\n";
                prompt += "네이버 카페 이용자의 약 38%가 10대 초반-후반에 집중되어 있으며, 유튜브는 10대 후반(30%) - 30대 초반(22%) 이용자 비중이 절반 이상을 차지하고 있음.\n";
                prompt += "네이버 카페는 24년 후반 ~ 25년 초반까지 10대 후반 - 20대 초반 위주로 커뮤니티가 형성되어 있었으나, 최근 10대의 비중이 지속적으로 상승하고 있음.\n";
                prompt += "유튜브는 35세~44세로 다소 높은 이용자 연령대를 보였으나, 최근에는 높은 연령대 비중이 크게 줄고 20대 초반 이용자가 빠르게 증가하는 추세임\n";
                prompt += "\n";

            } else {
                prompt += "현재 업로드된 데이터가 없습니다. 샘플 데이터를 기반으로 일반적인 클래시 로얄 커뮤니티 이슈를 생성합니다.\n\n";
                prompt += "--- 샘플 데이터 기반 일반적인 이슈 --- \n";
                prompt += "긍정적: 신규 업데이트에 대한 기대감, 밸런스 패치에 대한 긍정적 반응, 크리에이터 콘텐츠 활성화.\n";
                prompt += "부정적: 특정 카드 너프/버프 불만, 매칭 시스템 불공정성, 버그 및 기술적 문제.\n";
            }

            prompt += "위 데이터를 바탕으로 클래시 로얄 커뮤니티의 주요 긍정적 이슈와 부정적 이슈를 각각 3~5가지씩 요약하여 JSON 형식으로 제공해줘. 각 이슈는 간결한 문장으로 작성해줘. 형식은 다음과 같아: {\"positives\":[\"이슈1\", \"이슈2\"], \"negatives\":[\"이슈1\", \"이슈2\"]}";

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "positives": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "negatives": { "type": "ARRAY", "items": { "type": "STRING" } }
                            },
                            "propertyOrdering": ["positives", "negatives"]
                        }
                    }
                };
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);

                    // Append AI-generated issues
                    parsedJson.positives.forEach(issue => {
                        const div = document.createElement('div');
                        div.className = 'insight-item positive';
                        div.contentEditable = true;
                        div.innerHTML = `<p>${issue}</p>`;
                        positiveIssuesDiv.appendChild(div);
                    });

                    parsedJson.negatives.forEach(issue => {
                        const div = document.createElement('div');
                        div.className = 'insight-item negative';
                        div.contentEditable = true;
                        div.innerHTML = `<p>${issue}</p>`;
                        negativeIssuesDiv.appendChild(div);
                    });

                    showNotification('✅ AI가 주요 이슈를 성공적으로 생성했습니다!', 'success');
                } else {
                    throw new Error('AI 응답 구조가 예상과 다릅니다.');
                }
            } catch (error) {
                console.error('AI 주요 이슈 생성 오류:', error);
                showNotification(`❌ AI 이슈 생성 오류: ${error.message}`, 'error');
            }
        }


        // 전역 디버깅 객체
        window.clashRoyaleReportSystem = {
            uploadedData,
            chartInstances,
            excelProcessor,
            downloadSample,
            showNotification,
            updateAllCharts,
            handleFileUpload,
            generateAIKeyIssues // Expose AI function
        };

        console.log('🎮 클래시 로얄 실제 업무용 커뮤니티 리뷰 시스템 완성!');
        console.log('');
        console.log('📊 지원 기능:');
        console.log('  ✅ Excel 파일 (.xlsx) 전체 시트 자동 인식');
        console.log('  ✅ 필수 시트: Naver Cafe, Youtube, Youtube(ALL), Youtube community');
        console.log('  ✅ 자동 계산: 합계, 평균, 성장률, 참여도');
        console.log('  ✅ 데이터 품질 검증 및 누락 필드 알림');
        console.log('  ✅ AI가 임의 데이터 생성하지 않음');
        console.log('  ✅ CSV 파일 호환 (개별 업로드)');
        console.log('  ✅ 전문 PDF 내보내기');
        console.log('  ✅ 리포트 텍스트 및 제목 직접 수정 가능 (클릭하여 편집)');
        console.log('  ✅ 커스텀 텍스트/이미지 블록 추가 가능');
        console.log('  ✅ 년도/월 드롭다운으로 리포트 기간 선택 가능');
        console.log('  ✅ AI가 데이터 기반으로 주요 이슈 자동 생성 (수정 가능)');
        console.log('');
        console.log('🚀 사용법:');
        console.log('  1. 관리자 패널 열기');
        console.log('  2. Excel 파일 드래그 앤 드롭');
        console.log('  3. 자동 분석 결과 확인 후 "데이터 적용"');
        console.log('  4. 리포트 내 텍스트를 클릭하여 직접 수정');
        console.log('  5. 관리자 패널에서 "커스텀 콘텐츠 추가"로 텍스트/이미지 블록 추가');
        console.log('  6. "주요 이슈" 섹션에서 "AI가 주요 이슈 생성" 버튼 클릭');
        console.log('  7. PDF 내보내기');
        console.log('');
        console.log('🔧 디버깅: window.clashRoyaleReportSystem');
        console.log('📂 Excel 시트 구조 예시:');
        console.log('  • Naver Cafe: 기간, 조회수, 게시글수, 댓글수, 신규가입자수');
        console.log('  • Youtube: Status, Subscriber, VOD Views, Shorts Views, Total Likes');
        console.log('  • Youtube(ALL): Title, Views, Likes, Link, Thumbnail');
        console.log('  • Youtube community: Community Views, Community Likes, Community Counts');
    </script>
</body>
</html>
