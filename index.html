<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>월간 커뮤니티 리뷰 - Clash Royale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* 기본 스타일 초기화 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* CSS 변수 정의 (테마 변경에 사용) */
        :root {
            --primary: #1a1a1a; /* 주 색상 (어두운 텍스트, 배경 등) */
            --secondary: #ffffff; /* 보조 색상 (밝은 배경, 텍스트 등) */
            --accent: #4f46e5; /* 강조 색상 (버튼, 활성 상태 등) */
            --success: #10b981; /* 성공 메시지 색상 */
            --error: #ef4444; /* 오류 메시지 색상 */
            --border: #e5e7eb; /* 경계선 색상 */
            --hover: #f9fafb; /* 호버 시 배경 색상 */
            --text: #111827; /* 일반 텍스트 색상 */
            --text-muted: #6b7280; /* 음소거된 텍스트 색상 */
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); /* 그림자 효과 */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1); /* 큰 그림자 효과 */
            --radius: 12px; /* 둥근 모서리 반경 */
            --transition: all 0.2s ease; /* 부드러운 전환 효과 */
        }

        /* 바디 기본 스타일 */
        body { font-family: 'Segoe UI', -apple-system, sans-serif; background: #fafafa; color: var(--text); }

        /* 전체 컨테이너 레이아웃 */
        .container { display: flex; height: 100vh; }

        /* 사이드바 스타일 */
        .sidebar {
            width: 280px; background: var(--secondary); border-right: 1px solid var(--border);
            position: fixed; height: 100vh; overflow-y: auto; z-index: 1000; box-shadow: var(--shadow-lg);
        }

        /* 사이드바 헤더 */
        .sidebar-header {
            padding: 24px 20px; background: linear-gradient(135deg, var(--primary), var(--text-muted));
            color: var(--secondary); text-align: center;
        }
        .sidebar-header h1 { font-size: 16px; font-weight: 700; margin-bottom: 12px; line-height: 1.4; }

        /* 월 선택 드롭다운 */
        .month-selector { margin: 16px 0; }
        .month-selector select {
            width: 100%; padding: 10px 12px; border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius); background: rgba(255, 255, 255, 0.1);
            color: var(--secondary); font-size: 14px; cursor: pointer;
        }

        /* 네비게이션 메뉴 */
        .nav-menu { padding: 16px 0; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 20px; color: var(--text);
            text-decoration: none; border-left: 3px solid transparent; transition: var(--transition);
            font-weight: 500; font-size: 14px; cursor: pointer;
        }
        .nav-item::before { /* 활성 상태 표시를 위한 원형 마커 */
            content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
            margin-right: 12px; opacity: 0; transform: scale(0.5); transition: var(--transition);
        }
        .nav-item:hover, .nav-item.active { /* 호버 및 활성 상태 스타일 */
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.1), transparent);
            border-left-color: var(--accent); color: var(--accent); padding-left: 24px;
        }
        .nav-item:hover::before, .nav-item.active::before { opacity: 1; transform: scale(1); }

        /* 제어 버튼 영역 */
        .control-buttons { padding: 20px; border-top: 1px solid var(--border); background: var(--hover); }
        .control-btn {
            display: flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 10px;
            padding: 12px 16px; background: var(--primary); color: var(--secondary); border: none;
            border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 14px;
            transition: var(--transition);
        }
        .control-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .control-btn.edit-toggle { background: var(--accent); }
        .control-btn.edit-toggle.active { background: var(--error); } /* 편집 모드 활성 시 색상 변경 */
        .control-btn.admin { background: var(--success); }

        /* 메인 콘텐츠 영역 */
        .main-content {
            margin-left: 280px; flex: 1; height: 100vh; overflow-y: auto;
            background: #fafafa; position: relative;
        }

        /* 우측 상단 로고 */
        .logo-corner {
            position: fixed; top: 24px; right: 24px; z-index: 999; background: var(--secondary);
            padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .logo-corner img { height: 36px; width: auto; }

        /* 페이지 섹션 공통 스타일 */
        .page-section {
            min-height: 100vh; padding: 48px; border-bottom: 1px solid var(--border);
            background: var(--secondary); margin-bottom: 24px; border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        /* 페이지 제목 */
        .page-title {
            font-size: 28px; font-weight: 800; color: var(--primary); margin-bottom: 12px;
            padding-bottom: 16px; position: relative;
        }
        .page-title::after { /* 제목 아래 강조선 */
            content: ''; position: absolute; bottom: 0; left: 0; width: 48px; height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 2px;
        }

        /* 페이지 부제목 */
        .page-subtitle { font-size: 16px; color: var(--text-muted); margin-bottom: 32px; }

        /* 표지 페이지 */
        .cover-page {
            background: linear-gradient(135deg, var(--primary) 0%, var(--text-muted) 50%, var(--accent) 100%);
            color: var(--secondary); text-align: center; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        /* 표지 제목 및 정보 */
        .cover-title { font-size: 42px; font-weight: 900; margin-bottom: 16px; text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .cover-version, .cover-date, .cover-team { font-size: 16px; margin-bottom: 12px; opacity: 0.9; font-weight: 500; }

        /* 로고 컨테이너 (표지 내) */
        .logo-container { display: flex; gap: 48px; margin: 48px 0; align-items: center; }
        .logo-item { text-align: center; transition: var(--transition); }
        .logo-item:hover { transform: translateY(-4px); }
        .logo-item img {
            height: 72px; border-radius: var(--radius); background: rgba(255, 255, 255, 0.1);
            padding: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .logo-item span { display: block; margin-top: 12px; font-size: 13px; opacity: 0.8; font-weight: 600; }

        /* 요약 상자 */
        .summary-box {
            max-width: 700px; background: rgba(255, 255, 255, 0.1); padding: 32px;
            border-radius: 16px; backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 차트 컨테이너 */
        .chart-container {
            margin: 30px 0; padding: 25px; background: var(--secondary); border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; /* 차트와 테이블을 가로로 정렬 */
            flex-wrap: wrap; /* 작은 화면에서 줄바꿈 */
            gap: 20px; /* 차트와 테이블 사이 간격 */
        }
        .chart-canvas-wrapper {
            flex: 1; /* 차트가 공간을 차지하도록 */
            min-width: 300px; /* 최소 너비 설정 */
            position: relative; 
            height: 400px; /* 차트 높이 고정 */
        }
        .chart-summary-table {
            flex: 0 0 250px; /* 테이블 고정 너비 */
            min-width: 200px; /* 최소 너비 */
            margin-left: 20px; /* 차트와의 간격 */
            border-collapse: collapse;
            font-size: 13px;
        }
        .chart-summary-table th, .chart-summary-table td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: center;
        }
        .chart-summary-table th {
            background: var(--primary);
            color: var(--secondary);
        }
        .chart-summary-table tr:nth-child(even) {
            background: var(--hover);
        }

        .chart-title { font-size: 18px; font-weight: 600; color: var(--primary); margin-bottom: 20px; text-align: center; width: 100%; }
        .chart-controls { margin-bottom: 15px; text-align: right; width: 100%; }
        .color-picker {
            margin: 0 5px; padding: 5px 10px; border: 1px solid var(--border); border-radius: var(--radius);
            background: var(--secondary); cursor: pointer; font-size: 12px;
        }

        /* 데이터 테이블 */
        .data-table {
            width: 100%; border-collapse: collapse; margin: 24px 0; background: var(--secondary);
            border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow);
        }
        .data-table th {
            background: linear-gradient(135deg, var(--primary), var(--text-muted)); color: var(--secondary);
            padding: 16px 12px; text-align: center; font-weight: 600; font-size: 13px;
        }
        .data-table td { padding: 14px 12px; text-align: center; border-bottom: 1px solid var(--border); font-size: 14px; }
        .data-table tr:hover { background: var(--hover); }
        .data-table .positive { color: var(--success); font-weight: 700; } /* 긍정적 변화 색상 */
        .data-table .negative { color: var(--error); font-weight: 700; } /* 부정적 변화 색상 */

        /* 콘텐츠 카드 (사용되지 않지만 기존 스타일 유지) */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin: 25px 0; }
        .content-card {
            background: var(--hover);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure cards take full height of their grid area */
        }

        .content-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .video-thumbnail {
            width: 100%;
            height: 180px; /* Fixed height for thumbnails */
            object-fit: cover;
            display: block;
            border-bottom: 1px solid var(--border);
        }

        .video-info {
            padding: 15px;
            flex-grow: 1; /* Allow info section to grow and take available space */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push link to bottom */
        }

        .video-info h4 {
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .video-stats {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .video-link {
            display: inline-block;
            margin-top: auto; /* Push to the bottom */
            padding: 8px 12px;
            background: var(--accent);
            color: var(--secondary);
            text-decoration: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
        }

        .video-link:hover {
            background: #3f36c9; /* Darker accent on hover */
        }

        .metrics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-card {
            background: var(--secondary);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        .metric-card h4 {
            font-size: 15px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .metric-card p {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        /* 페이지 하단 노트 */
        .page-notes {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- 관리자 모달 -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-panel">
            <div class="admin-close-bar">
                <h2>관리자 패널</h2>
                <button class="admin-close" onclick="closeAdminPanel()">&times;</button>
            </div>
            
            <div class="admin-panel-content">
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchTab(event, 'data')">데이터 관리</button>
                    <button class="admin-tab" onclick="switchTab(event, 'content')">콘텐츠 편집</button>
                    <button class="admin-tab" onclick="switchTab(event, 'design')">디자인 설정</button>
                    <button class="admin-tab" onclick="switchTab(event, 'export')">내보내기</button>
                </div>
                
                <!-- 데이터 관리 섹션 -->
                <div class="admin-section active" id="data-section">
                    <h3>데이터 관리</h3>
                    
                    <div class="form-group">
                        <label>페이지별 CSV 데이터 업로드</label>
                        <select id="pageDataSelector" onchange="updateCsvUploadInfo()">
                            <option value="">페이지를 선택하세요</option>
                            <option value="naver-total" data-fields="기간,연령,조회수,방문횟수,게시글수,댓글수,신규 가입자수">Naver Cafe 데이터</option>
                            <option value="youtube-total" data-fields="Status,+/-,Total,VOD Views,Shorts Views,Total,VOD Likes,Shorts Likes,Total,VOD Counts,Shorts Counts,Views,Likes,Counts">YouTube 요약 데이터 (Youtube.csv 형식)</option>
                            <option value="youtube-detail" data-fields="Title,Date,View,Click,Likes,Age,13-17,18-24,25-34,35-44,45~,Note">YouTube 상세 데이터 (Youtube(ALL).csv 형식)</option>
                        </select>
                    </div>
                    
                    <div id="csvUploadSection" style="display: none;">
                        <div class="form-group">
                            <label>CSV 파일 업로드</label>
                            <div class="file-upload" id="csvUpload">
                                <p>CSV 파일을 여기에 드래그하거나 클릭하세요</p>
                                <input type="file" accept=".csv" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>예상 CSV 형식</label>
                            <div id="csvFormatInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
                        </div>
                    </div>
                    
                    <div id="dataPreview" style="display: none;">
                        <div class="form-group">
                            <label>업로드된 데이터 미리보기</label>
                            <div style="max-height: 300px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
                                <table id="previewTable" class="data-table"></table>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>월별 필터링</label>
                            <select id="monthFilter" onchange="filterPreviewData()">
                                <option value="">전체 데이터</option>
                                <option value="01">1월</option><option value="02">2월</option><option value="03">3월</option>
                                <option value="04">4월</option><option value="05">5월</option><option value="06">6월</option>
                                <option value="07">7월</option><option value="08">8월</option><option value="09">9월</option>
                                <option value="10">10월</option><option value="11">11월</option><option value="12">12월</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="control-btn" onclick="applyDataChanges()">📊 데이터 적용</button>
                        <button class="control-btn" onclick="forceRefreshAll()">🔄 전체 새로고침</button>
                        <button class="control-btn" onclick="debugDataFlow()">🔍 디버그</button>
                    </div>
                </div>

                <!-- 콘텐츠 편집 섹션 -->
                <div class="admin-section" id="content-section">
                    <h3>콘텐츠 편집</h3>
                    <div class="form-group">
                        <label for="contentEditorSelector">편집할 섹션 선택</label>
                        <select id="contentEditorSelector" onchange="loadContentForEdit()">
                            <option value="monthlySummary">표지 - 월간 요약</option>
                            <option value="cover-notes">표지 - 페이지 노트</option>
                            <option value="youtube-total-notes">YouTube 데이터 - 페이지 노트</option>
                            <option value="youtube-charts-notes">YouTube 차트 - 페이지 노트</option>
                            <option value="youtube-detail-notes">YouTube 상세 데이터 - 페이지 노트</option>
                            <option value="youtube-community-notes">YouTube 커뮤니티 - 페이지 노트</option>
                            <option value="naver-total-notes">Naver Cafe 데이터 - 페이지 노트</option>
                            <option value="naver-charts-notes">Naver Cafe 차트 - 페이지 노트</option>
                            <option value="custom-page-1">사용자 정의 페이지</option>
                            <option value="custom-page-1-notes">사용자 정의 페이지 - 페이지 노트</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contentEditor">내용 (HTML/Markdown)</label>
                        <textarea id="contentEditor"></textarea>
                    </div>
                    <div class="form-group" id="imageEditGroup" style="display: none;">
                        <label for="imageEditor">이미지 URL (선택 사항)</label>
                        <input type="text" id="imageEditor" placeholder="이미지 URL을 입력하세요">
                    </div>
                    <button class="control-btn" onclick="saveContentChanges()">저장</button>
                </div>
                
                <!-- 디자인 설정 섹션 -->
                <div class="admin-section" id="design-section">
                    <h3>디자인 설정</h3>
                    <div class="form-group">
                        <label>테마 선택</label>
                        <select id="themeSelector">
                            <option value="light">라이트 테마</option>
                            <option value="dark">다크 테마</option>
                        </select>
                    </div>
                    <button class="control-btn" onclick="applyTheme()">디자인 적용</button>
                </div>
                
                <!-- 내보내기 섹션 -->
                <div class="admin-section" id="export-section">
                    <h3>내보내기 설정</h3>
                    <div class="form-group">
                        <label>내보내기 형식</label>
                        <select id="exportFormat">
                            <option value="html">HTML</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <button class="control-btn" onclick="exportReport()">보고서 내보내기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 좌측 네비게이션 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="editable" data-field="title">월간 커뮤니티 리뷰<br>Clash Royale</h1>
                <div class="month-selector">
                    <select id="monthSelector"></select>
                </div>
            </div>
            
            <div class="nav-menu" id="navMenu">
                <a href="#cover" class="nav-item active">표지 및 개요</a>
                <a href="#youtube-total" class="nav-item">YouTube 데이터</a>
                <a href="#youtube-charts" class="nav-item">YouTube 차트</a>
                <a href="#youtube-detail" class="nav-item">YouTube 상세 데이터</a>
                <a href="#youtube-community" class="nav-item">YouTube 커뮤니티</a>
                <a href="#naver-total" class="nav-item">Naver Cafe 데이터</a>
                <a href="#naver-charts" class="nav-item">Naver Cafe 차트</a>
                <a href="#custom-page-1" class="nav-item">사용자 정의 페이지</a>
            </div>
            
            <div class="control-buttons">
                <button class="control-btn edit-toggle" onclick="openAdminPanel()" id="editToggle">⚙️ 관리자 패널</button>
            </div>
        </nav>

        <!-- 클래시 로얄 로고 (우측 상단 고정) -->
        <div class="logo-corner">
            <img src="https://i.imgur.com/N2gxrkh.png" alt="Clash Royale" onerror="this.style.display='none'">
        </div>

        <!-- 메인 콘텐츠 -->
        <main class="main-content" id="mainContent">
            <!-- 표지 섹션 -->
            <section id="cover" class="page-section cover-page">
                <h1 class="cover-title" data-field="cover_title">월간 커뮤니티 리뷰</h1>
                <h2 class="cover-title" data-field="cover_subtitle" style="font-size: 36px; margin-top: -10px;">Clash Royale</h2>
                <div class="cover-version" data-field="version">Ver 1.0</div>
                <div class="cover-date" data-field="date">2025.07.17</div>
                <div class="cover-team" data-field="team">Community Marketing Team</div>
                
                <div class="logo-container">
                    <div class="logo-item">
                        <img src="https://i.imgur.com/N2gxrkh.png" alt="Clash Royale" onerror="this.style.display='none'">
                        <span>Clash Royale</span>
                    </div>
                    <div class="logo-item">
                        <img src="https://i.imgur.com/geVZCaY.png" alt="PRABBIT" onerror="this.style.display='none'">
                        <span>PRABBIT</span>
                    </div>
                </div>
                
                <div class="summary-box">
                    <h3 style="margin-bottom: 15px;">월간 요약</h3>
                    <p data-field="monthlySummary" id="monthlySummary">선택된 월의 클래시 로얄 커뮤니티 데이터를 종합 분석한 보고서입니다.</p>
                </div>
                <div class="page-notes" id="cover-notes"></div>
            </section>

            <!-- YouTube 데이터 섹션 -->
            <section id="youtube-total" class="page-section">
                <h2 class="page-title">YouTube 데이터</h2>
                <p class="page-subtitle">클래시 로얄 YouTube 채널 통계</p>
                
                <table class="data-table" id="youtubeDataTable">
                    <thead>
                        <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th><th>변화율</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="page-notes" id="youtube-total-notes"></div>
            </section>

            <!-- YouTube 차트 섹션 -->
            <section id="youtube-charts" class="page-section">
                <h2 class="page-title">YouTube 차트</h2>
                <p class="page-subtitle">월별 트렌드 시각화</p>
                
                <div class="chart-container">
                    <div class="chart-controls">
                        <select class="color-picker" onchange="updateChartColors('youtubeChart1', this.value)">
                            <option value="blue">파란색</option>
                            <option value="red">빨간색</option>
                            <option value="green">초록색</option>
                        </select>
                    </div>
                    <div class="chart-canvas-wrapper">
                        <div class="chart-title">구독자 수 & 영상 수</div>
                        <canvas id="youtubeChart1"></canvas>
                    </div>
                    <table class="chart-summary-table" id="youtubeChart1Table">
                        <thead>
                            <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="chart-container">
                    <div class="chart-canvas-wrapper">
                        <div class="chart-title">총 조회수 & 좋아요</div>
                        <canvas id="youtubeChart2"></canvas>
                    </div>
                    <table class="chart-summary-table" id="youtubeChart2Table">
                        <thead>
                            <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="page-notes" id="youtube-charts-notes"></div>
            </section>

            <!-- YouTube 상세 데이터 섹션 추가 -->
            <section id="youtube-detail" class="page-section">
                <h2 class="page-title">YouTube 상세 데이터</h2>
                <p class="page-subtitle">월별 영상별 상세 통계 및 인기 영상</p>

                <div class="metrics-summary" id="youtubeDetailSummary">
                    <!-- 평균 데이터가 여기에 동적으로 로드됩니다. -->
                </div>

                <h3>이번 달 업로드된 영상</h3>
                <div class="video-grid" id="uploadedVideosGrid">
                    <!-- 업로드된 영상 목록이 여기에 동적으로 로드됩니다. -->
                </div>

                <h3>인기 영상 (조회수 기준 상위 3개)</h3>
                <div class="video-grid" id="topVideosGrid">
                    <!-- 인기 영상 목록이 여기에 동적으로 로드됩니다. -->
                </div>
                <div class="page-notes" id="youtube-detail-notes"></div>
            </section>

            <!-- YouTube 커뮤니티 섹션 추가 -->
            <section id="youtube-community" class="page-section">
                <h2 class="page-title">YouTube 커뮤니티</h2>
                <p class="page-subtitle">YouTube 커뮤니티 탭 활동 통계</p>
                
                <table class="data-table" id="youtubeCommunityTable">
                    <thead>
                        <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th><th>총계</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="page-notes" id="youtube-community-notes"></div>
            </section>

            <!-- Naver Cafe 데이터 섹션 -->
            <section id="naver-total" class="page-section">
                <h2 class="page-title">Naver Cafe 데이터</h2>
                <p class="page-subtitle">네이버 카페 통계</p>
                
                <table class="data-table" id="naverDataTable">
                    <thead>
                        <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th><th>총계</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="page-notes" id="naver-total-notes"></div>
            </section>

            <!-- Naver Cafe 차트 섹션 -->
            <section id="naver-charts" class="page-section">
                <h2 class="page-title">Naver Cafe 차트</h2>
                <p class="page-subtitle">커뮤니티 활동 트렌드</p>
                
                <div class="chart-container">
                    <div class="chart-canvas-wrapper">
                        <div class="chart-title">게시글 & 댓글 수</div>
                        <canvas id="naverChart1"></canvas>
                    </div>
                    <table class="chart-summary-table" id="naverChart1Table">
                        <thead>
                            <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="chart-container">
                    <div class="chart-canvas-wrapper">
                        <div class="chart-title">연령대별 분포</div>
                        <canvas id="ageChart"></canvas>
                    </div>
                    <table class="chart-summary-table" id="ageChartTable">
                        <thead>
                            <tr><th>항목</th><th>4월</th><th>5월</th><th>6월</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="page-notes" id="naver-charts-notes"></div>
            </section>

            <!-- 사용자 정의 페이지 (빈 페이지) -->
            <section id="custom-page-1" class="page-section">
                <h2 class="page-title" id="custom-page-1-title" data-field="custom-page-1-title">사용자 정의 페이지</h2>
                <p class="page-subtitle" id="custom-page-1-subtitle" data-field="custom-page-1-subtitle">이 페이지의 내용은 관리자 패널에서 편집할 수 있습니다.</p>
                <div id="custom-page-1-content">
                    <!-- 사용자 정의 콘텐츠가 여기에 로드됩니다. -->
                    <p>여기에 사용자 정의 내용을 추가하거나 편집할 수 있습니다. 관리자 패널의 '콘텐츠 편집' 탭을 사용해 보세요.</p>
                    <img id="custom-page-1-image" src="https://placehold.co/600x300/e0e0e0/000000?text=Your+Image+Here" alt="Custom Image" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 20px;">
                </div>
                <div class="page-notes" id="custom-page-1-notes"></div>
            </section>

        </main>
    </div>

    <!-- 알림 메시지 표시 영역 -->
    <div class="notification" id="notification"></div>

    <script>
        // 전역 변수 선언
        let editMode = false; // 편집 모드 상태 (현재는 관리자 패널 진입 여부만 제어)
        let currentMonth = '2025_06'; // 현재 선택된 월 (기본값)
        let chartInstances = {}; // Chart.js 인스턴스를 저장하는 객체
        let csvDataStore = {}; // 업로드된 CSV 원본 데이터를 저장하는 객체
        let currentCsvData = null; // 현재 미리보기에 표시되는 CSV 데이터
        let reportData = {}; // 보고서에 사용될 최종 데이터 (월별로 구성)
        let editableContentStore = { // 편집 가능한 콘텐츠를 저장하는 객체
            monthlySummary: "선택된 월의 클래시 로얄 커뮤니티 데이터를 종합 분석한 보고서입니다.",
            "cover-notes": "",
            "youtube-total-notes": "",
            "youtube-charts-notes": "",
            "youtube-detail-notes": "",
            "youtube-community-notes": "",
            "naver-total-notes": "",
            "naver-charts-notes": "",
            "custom-page-1": {
                title: "사용자 정의 페이지",
                subtitle: "이 페이지의 내용은 관리자 패널에서 편집할 수 있습니다.",
                content: "<p>여기에 사용자 정의 내용을 추가하거나 편집할 수 있습니다. 관리자 패널의 '콘텐츠 편집' 탭을 사용해 보세요.</p>",
                image: "https://placehold.co/600x300/e0e0e0/000000?text=Your+Image+Here"
            },
            "custom-page-1-notes": ""
        };

        // 색상 스키마 정의
        const colorSchemes = {
            blue: ['rgba(79, 70, 229, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)'],
            red: ['rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(16, 185, 129, 0.8)'],
            green: ['rgba(16, 185, 129, 0.8)', 'rgba(79, 70, 229, 0.8)', 'rgba(239, 68, 68, 0.8)']
        };

        // DOMContentLoaded 이벤트 리스너: 문서 로드 완료 후 초기화 함수 호출
        document.addEventListener('DOMContentLoaded', function() {
            generateMonthOptions(); // 월 선택 옵션 생성
            setupNavigation(); // 네비게이션 설정
            setupFileUpload(); // 파일 업로드 기능 설정
            initializeCharts(); // 차트 초기 설정
            loadInitialData(); // 초기 데이터 로드
            loadContentForEdit(); // 콘텐츠 편집기 초기 로드
        });

        // 초기 데이터 로드 (보고서 데이터 구조를 미리 정의하거나, 기본값을 설정)
        function loadInitialData() {
            // 예시 데이터 (실제 데이터는 CSV 업로드 후 적용됨)
            reportData = {
                '2025_04': {
                    month: '4월',
                    date: '2025.04.01',
                    youtube: {
                        subscribers: 327139, videos: 903, vod_views: 27177, shorts_views: 105990,
                        total_likes: 2378, vod_likes: 287, shorts_likes: 2091, total_counts: 13, vod_counts: 2, shorts_counts: 11,
                        community_views: 120294, community_likes: 2596, community_counts: 13
                    },
                    youtube_detail: [
                        { "title": "클래시 플레이그라운드 현장 스케치", "publish_date": "2025년 4월 23일 (월)", "views": 13511, "watch_time_hours": 71.7, "subscribers_gained": 16, "avg_view_duration": "0:19", "impressions": 33223, "ctr": 3.2, "link": "https://youtu.be/example1", "thumbnail": "https://placehold.co/480x270/cccccc/333333?text=Video1", "click": 0, "likes": 0 },
                        { "title": "(자막) 신규 게임 모드?!", "publish_date": "2025년 4월 29일 (일)", "views": 70958, "watch_time_hours": 1963.5, "subscribers_gained": 218, "avg_view_duration": "1:39", "impressions": 247281, "ctr": 12.4, "link": "https://youtu.be/example2", "thumbnail": "https://placehold.co/480x270/cccccc/333333?text=Video2", "click": 0, "likes": 0 }
                    ],
                    naver_cafe: {
                        join: 207716, posts: 1846, total_views: 442284, comments: 5213, unique_visitors: 27952
                    },
                    age_distribution: { "10대": 160618, "20대": 131712, "30대": 51782, "40대 이상": 80187 }
                },
                '2025_05': {
                    month: '5월',
                    date: '2025.05.01',
                    youtube: {
                        subscribers: 327807, videos: 668, vod_views: 110784, shorts_views: 145872,
                        total_likes: 4812, vod_likes: 1910, shorts_likes: 2902, total_counts: 24, vod_counts: 10, shorts_counts: 14,
                        community_views: 330596, community_likes: 5659, community_counts: 24
                    },
                    youtube_detail: [
                        { "title": "드래곤을 진화시키는 방법!🔥", "publish_date": "2025년 5월 02일 (월)", "views": 21515, "watch_time_hours": 53.2, "subscribers_gained": 10, "avg_view_duration": "0:12", "impressions": 89247, "ctr": 6.8, "link": "https://youtu.be/example3", "thumbnail": "https://placehold.co/480x270/cccccc/333333?text=Video3", "click": 0, "likes": 0 },
                        { "title": "(자막) 스토어 스페셜을 놓치지 마세요!🎁", "publish_date": "2025년 5월 09일 (월)", "views": 12883, "watch_time_hours": 28.2, "subscribers_gained": 1, "avg_view_duration": "0:15", "impressions": 47933, "ctr": 6.6, "link": "https://youtu.be/example4", "thumbnail": "https://placehold.co/480x270/cccccc/333333?text=Video4", "click": 0, "likes": 0 }
                    ],
                    naver_cafe: {
                        join: 208366, posts: 2009, total_views: 500689, comments: 5521, unique_visitors: 45861
                    },
                    age_distribution: { "10대": 179263, "20대": 138393, "30대": 67609, "40대 이상": 85410 }
                },
                '2025_06': {
                    month: '6월',
                    date: '2025.06.01',
                    youtube: {
                        subscribers: 328528, videos: 721, vod_views: 82691, shorts_views: 280886,
                        total_likes: 6087, vod_likes: 740, shorts_likes: 5347, total_counts: 15, vod_counts: 7, shorts_counts: 8,
                        community_views: 228439, community_likes: 5456, community_counts: 15
                    },
                    youtube_detail: [
                        { "title": "안돼애애애😂 [클래시 로얄]", "publish_date": "2025년 6월 15일 (일)", "views": 118010, "watch_time_hours": 217.3, "subscribers_gained": 62, "avg_view_duration": "0:14", "impressions": 61639, "ctr": 4.3, "link": "https://youtube.com/shorts/GVXPALB1_jU?feature=share", "thumbnail": "https://placehold.co/480x270/cccccc/333333?text=Video5", "click": 0, "likes": 0 },
                        { "title": "(자막) 신규 게임 모드?! 트로피 로드 재조정, 신규 전설 카드 그리고!🃏 TV로얄", "publish_date": "2025년 6월 29일 (일)", "views": 70930, "watch_time_hours": 1963.5, "subscribers_gained": 231, "avg_view_duration": "1:39", "impressions": 247398, "ctr": 12.4, "link": "https://youtu.be/FL7vvTfWRA0", "thumbnail": "https://placehold.co/480x270/cccccc/333333?text=Video6", "click": 0, "likes": 0 },
                        { "title": "(자막) 검 vs 철퇴! 🤜🤛 [클래시 로얄]", "publish_date": "2025년 6월 27일 (금)", "views": 46354, "watch_time_hours": 204.9, "subscribers_gained": 81, "avg_view_duration": "0:26", "impressions": 114392, "ctr": 12.5, "link": "https://youtube.com/shorts/QKdUFN77j3Q?feature=share", "thumbnail": "https://placehold.co/480x270/cccccc/333333?text=Video7", "click": 0, "likes": 0 }
                    ],
                    naver_cafe: {
                        join: 209411, posts: 2372, total_views: 515864, comments: 7052, unique_visitors: 39820
                    },
                    age_distribution: { "10대": 196418, "20대": 153453, "30대": 57974, "40대 이상": 85007 }
                }
            };
            loadMonthData(currentMonth); // 현재 월 데이터 로드 및 UI 업데이트
        }

        // 월 선택 드롭다운 옵션 생성
        function generateMonthOptions() {
            const selector = document.getElementById('monthSelector');
            // 2023년부터 2050년까지의 월 옵션 생성
            for (let year = 2023; year <= 2050; year++) {
                for (let month = 1; month <= 12; month++) {
                    const monthStr = month.toString().padStart(2, '0'); // 월을 두 자리 숫자로 포맷 (예: 01, 02)
                    const value = `${year}_${monthStr}`; // 옵션 값 (예: 2025_06)
                    const option = new Option(`${year}년 ${month}월`, value); // 표시 텍스트와 값 설정
                    if (value === currentMonth) option.selected = true; // 현재 월이 기본 선택되도록 설정
                    selector.appendChild(option); // 드롭다운에 옵션 추가
                }
            }
            // 월 선택 변경 시 이벤트 리스너
            selector.addEventListener('change', (e) => {
                currentMonth = e.target.value; // 선택된 월로 currentMonth 업데이트
                loadMonthData(currentMonth); // 해당 월의 데이터 로드
            });
        }

        // 네비게이션 메뉴 설정 (스크롤 및 활성 클래스)
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault(); // 기본 링크 동작 방지
                    e.stopPropagation(); // 이벤트 버블링 방지
                    
                    const targetId = this.getAttribute('href').substring(1); // href에서 ID 추출
                    const target = document.getElementById(targetId); // 해당 ID의 요소 가져오기
                    if (target) {
                        // 모든 네비게이션 항목의 'active' 클래스 제거
                        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                        this.classList.add('active'); // 클릭된 항목에 'active' 클래스 추가
                        // 해당 섹션으로 부드럽게 스크롤
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    return false; // 추가적인 동작 방지
                });
            });
        }

        // 파일 업로드 (드래그 앤 드롭 및 클릭) 설정
        function setupFileUpload() {
            const uploadArea = document.getElementById('csvUpload'); // 파일 업로드 영역
            const fileInput = uploadArea.querySelector('input[type="file"]'); // 숨겨진 파일 입력 필드
            
            uploadArea.addEventListener('click', () => fileInput.click()); // 클릭 시 파일 선택 다이얼로그 열기
            
            // 드래그 앤 드롭 이벤트 리스너
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, function(e) {
                    e.preventDefault(); // 기본 동작 방지
                    e.stopPropagation(); // 이벤트 버블링 방지
                    
                    if (eventName === 'dragover') this.classList.add('dragover'); // 드래그 오버 시 스타일 변경
                    else if (eventName === 'dragleave') this.classList.remove('dragover'); // 드래그 리브 시 스타일 복원
                    else if (eventName === 'drop') {
                        this.classList.remove('dragover'); // 드롭 시 스타일 복원
                        if (e.dataTransfer.files.length > 0) {
                            handleCsvUpload(e.dataTransfer.files[0]); // 드롭된 파일 처리
                        }
                    }
                });
            });
            
            // 파일 입력 필드 변경 시 이벤트 리스너
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCsvUpload(e.target.files[0]); // 선택된 파일 처리
                }
            });
        }

        // CSV 파일 업로드 처리
        function handleCsvUpload(file) {
            const selectedPage = document.getElementById('pageDataSelector').value; // 선택된 페이지 유형
            if (!selectedPage) { 
                showNotification('페이지를 선택하세요', 'error'); // 페이지 선택 안 했을 경우 알림
                return; 
            }
            
            const reader = new FileReader(); // FileReader 객체 생성
            reader.onload = function(e) {
                if (selectedPage === 'naver-total') {
                    processNaverCafeCSV(e.target.result, selectedPage);
                } else if (selectedPage === 'youtube-total') {
                    processYoutubeTotalCSV(e.target.result, selectedPage);
                } else {
                    Papa.parse(e.target.result, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => processCsvData(results.data, selectedPage)
                    });
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        // 네이버 카페 CSV 데이터 특수 처리 (헤더 위치가 불규칙한 경우)
        function processNaverCafeCSV(csvText, pageType) {
            const lines = csvText.split('\n');
            const processedData = [];
            let headerIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('기간') && lines[i].includes('연령')) {
                    headerIndex = i;
                    break;
                }
            }
            
            if (headerIndex === -1) { 
                showNotification('네이버 카페 데이터 형식 오류: 헤더를 찾을 수 없습니다.', 'error'); 
                return; 
            }
            
            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = parseCSVLine(line);
                if (columns.length < 3) continue;
                
                const period = columns[1]?.trim();
                const ageGroup = columns[2]?.trim();
                
                if (period && period.match(/\d{4}\.\d{2}/) && ageGroup === '전 연령') {
                    processedData.push({
                        date: period,
                        total_views: parseNumber(columns[3]),
                        visits: parseNumber(columns[4]),
                        posts: parseNumber(columns[5]),
                        comments: parseNumber(columns[6]),
                        new_members: parseNumber(columns[7])
                    });
                } 
                else if (period && period.match(/\d{4}\.\d{2}/) && ['10대', '20대', '30대', '40대 이상'].includes(ageGroup)) {
                    const lastData = processedData[processedData.length - 1];
                    if (lastData && lastData.date === period) {
                        if (!lastData.age_distribution) lastData.age_distribution = {};
                        lastData.age_distribution[ageGroup] = parseNumber(columns[3]);
                    }
                }
            }
            
            processCsvData(processedData, pageType);
        }

        // YouTube Total CSV 데이터 특수 처리 (Youtube.csv)
        function processYoutubeTotalCSV(csvText, pageType) {
            const lines = csvText.split('\n');
            const processedData = [];
            let headerLine = null;
            let subscriberLine = null;

            // 헤더 라인과 구독자/영상 수 라인 찾기
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('Status,+/-,Total,VOD Views')) {
                    headerLine = lines[i];
                }
                if (lines[i].includes(',Subscriber,,Videos')) {
                    subscriberLine = lines[i];
                }
                // 실제 데이터 시작 지점 (23년 1월 등)
                if (lines[i].trim().match(/^\d{2}년 \d{1,2}월/)) {
                    const dataLine = lines[i].trim();
                    const columns = parseCSVLine(dataLine);

                    if (headerLine && subscriberLine && columns.length >= 14) { // 충분한 컬럼이 있는지 확인
                        const status = columns[0]; // "23년 1월"
                        const subscriber = parseNumber(columns[1]); // "314,491"
                        const videosTotal = parseNumber(columns[2]); // "37,405" (Total Videos)
                        const vodViews = parseNumber(columns[3]); // "14,388"
                        const shortsViews = parseNumber(columns[4]); // "23,017"
                        const likesTotal = parseNumber(columns[5]); // "949개" (Total Likes)
                        const vodLikes = parseNumber(columns[6]); // "165개"
                        const shortsLikes = parseNumber(columns[7]); // "784개"
                        const countsTotal = parseNumber(columns[8]); // "4" (Total Counts)
                        const vodCounts = parseNumber(columns[9]); // "2"
                        const shortsCounts = parseNumber(columns[10]); // "2"
                        const communityViews = parseNumber(columns[11]); // "287,262"
                        const communityLikes = parseNumber(columns[12]); // "3,387"
                        const communityCounts = parseNumber(columns[13]); // "27"

                        processedData.push({
                            status: status,
                            subscriber: subscriber,
                            videos: videosTotal,
                            vod_views: vodViews,
                            shorts_views: shortsViews,
                            total_likes: likesTotal,
                            vod_likes: vodLikes,
                            shorts_likes: shortsLikes,
                            total_counts: countsTotal,
                            vod_counts: vodCounts,
                            shorts_counts: shortsCounts,
                            community_views: communityViews,
                            community_likes: communityLikes,
                            community_counts: communityCounts
                        });
                    }
                }
            }
            processCsvData(processedData, pageType);
        }


        // CSV 줄을 쉼표와 따옴표를 고려하여 파싱하는 헬퍼 함수
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current); // 마지막 컬럼 추가
            return result.map(s => s.trim()); // 각 컬럼의 공백 제거
        }

        // 문자열에서 숫자만 파싱하는 헬퍼 함수 (쉼표, 따옴표 제거)
        function parseNumber(str) {
            if (typeof str === 'number') return str; // 이미 숫자인 경우 그대로 반환
            if (!str || String(str).trim() === '-' || String(str).trim() === '') return 0; // 빈 값이거나 '-'인 경우 0 반환
            const cleaned = String(str).replace(/[",\s]/g, ''); // 쉼표, 따옴표, 공백 제거
            const num = parseInt(cleaned, 10); // 정수로 변환
            return isNaN(num) ? 0 : num; // 숫자가 아니면 0 반환
        }

        // CSV 데이터 파싱 후 처리 (미리보기 및 저장)
        function processCsvData(data, pageType) {
            currentCsvData = data; // 현재 미리보기에 사용될 데이터
            csvDataStore[pageType] = data; // 원본 CSV 데이터 저장
            displayDataPreview(data); // 데이터 미리보기 표시
            showNotification(`${data.length}개 데이터 업로드 완료`, 'success'); // 알림 표시
        }

        // 데이터 미리보기 테이블에 표시
        function displayDataPreview(data) {
            if (!data || data.length === 0) {
                document.getElementById('dataPreview').style.display = 'none'; // 데이터 없으면 미리보기 숨김
                return;
            }
            
            document.getElementById('dataPreview').style.display = 'block'; // 미리보기 표시
            const table = document.getElementById('previewTable');
            const headers = Object.keys(data[0] || {}); // 첫 번째 행의 키를 헤더로 사용
            
            // 테이블 헤더 생성
            let headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            // 테이블 바디 생성 (최대 5개 행만 미리보기)
            let bodyHtml = `<tbody>${data.slice(0, 5).map(row => 
                `<tr>${headers.map(h => `<td>${JSON.stringify(row[h]) || ''}</td>`).join('')}</tr>`
            ).join('')}</tbody>`; // 객체는 JSON.stringify로 표시

            table.innerHTML = headerHtml + bodyHtml; // 테이블에 HTML 삽입
        }

        // 미리보기 데이터 월별 필터링
        function filterPreviewData() {
            const monthFilter = document.getElementById('monthFilter').value; // 선택된 월 필터 값
            const selectedPage = document.getElementById('pageDataSelector').value; // 선택된 페이지 유형
            const dataToFilter = csvDataStore[selectedPage]; // 해당 페이지의 원본 CSV 데이터

            if (!dataToFilter || dataToFilter.length === 0 || !monthFilter) {
                displayDataPreview(dataToFilter); // 필터 없으면 전체 데이터 표시
                return;
            }
            
            const filtered = dataToFilter.filter(row => {
                const dateValue = row.date || row['동영상 게시 시간'] || row.기간 || row.Date || row.status || ''; // 'date' 또는 '기간' 컬럼 사용
                if (dateValue.includes('.')) { // 'YYYY.MM' 형식 처리 (Naver Cafe, youtube-total)
                    const [year, month] = dateValue.split('.');
                    return `${year}_${month.padStart(2, '0')}` === `${new Date().getFullYear()}_${monthFilter}`; // 현재 연도와 월 필터 적용
                } else if (dateValue.includes('년') && dateValue.includes('월')) { // 'YYYY년 MM월 DD일 (요일)' 형식 처리 (youtube-detail, youtube-total 일부)
                    const yearMatch = dateValue.match(/(\d{4})년/);
                    const monthMatch = dateValue.match(/(\d{1,2})월/);
                    if (yearMatch && monthMatch) {
                        const rowYear = yearMatch[1];
                        const rowMonth = monthMatch[1].padStart(2, '0');
                        return `${rowYear}_${rowMonth}` === `${new Date().getFullYear()}_${monthFilter}`; // 현재 연도와 월 필터 적용
                    }
                } else if (dateValue.includes('월')) { // 'MM월 DD일 (요일)' 형식 처리 (youtube-detail, youtube-total 일부)
                    const monthMatch = dateValue.match(/(\d{1,2})월/);
                    if (monthMatch) {
                        return monthMatch[1].padStart(2, '0') === monthFilter;
                    }
                }
                return false;
            });
            
            displayDataPreview(filtered); // 필터링된 데이터 미리보기 표시
            showNotification(`${filtered.length}개 ${monthFilter}월 데이터 필터링`, 'success');
        }

        // 업로드된 CSV 데이터를 보고서 데이터 구조에 맞게 변환 및 적용
        function applyDataChanges() {
            try {
                // csvDataStore에 저장된 모든 CSV 데이터를 순회
                for (const [pageType, csvData] of Object.entries(csvDataStore)) {
                    // 각 월별로 데이터를 변환하여 reportData에 저장
                    for (let year = 2023; year <= 2050; year++) {
                        for (let month = 1; month <= 12; month++) {
                            const monthStr = month.toString().padStart(2, '0');
                            const targetMonth = `${year}_${monthStr}`;

                            // 해당 월의 reportData 객체가 없으면 생성
                            if (!reportData[targetMonth]) {
                                reportData[targetMonth] = { 
                                    month: monthStr + '월', // '06월'
                                    date: `${year}.${monthStr}.01` // '2025.06.01'
                                };
                            }
                            
                            // 페이지 유형에 따라 reportData에 데이터 할당
                            switch (pageType) {
                                case 'youtube-total':
                                    const youtubeTotalRow = csvData.find(row => {
                                        if (row.status) { // Youtube.csv의 'status' 컬럼 사용
                                            const statusDate = row.status;
                                            const yearMatch = statusDate.match(/(\d{2})년/);
                                            const monthMatch = statusDate.match(/(\d{1,2})월/);
                                            if (yearMatch && monthMatch) {
                                                const fullYear = `20${yearMatch[1]}`;
                                                const monthNum = monthMatch[1].padStart(2, '0');
                                                return `${fullYear}_${monthNum}` === targetMonth;
                                            }
                                        }
                                        return false;
                                    });

                                    if (youtubeTotalRow) {
                                        reportData[targetMonth].youtube = {
                                            subscribers: parseNumber(youtubeTotalRow.subscriber),
                                            videos: parseNumber(youtubeTotalRow.videos),
                                            vod_views: parseNumber(youtubeTotalRow.vod_views),
                                            shorts_views: parseNumber(youtubeTotalRow.shorts_views),
                                            total_likes: parseNumber(youtubeTotalRow.total_likes),
                                            vod_likes: parseNumber(youtubeTotalRow.vod_likes),
                                            shorts_likes: parseNumber(youtubeTotalRow.shorts_likes),
                                            total_counts: parseNumber(youtubeTotalRow.total_counts),
                                            vod_counts: parseNumber(youtubeTotalRow.vod_counts),
                                            shorts_counts: parseNumber(youtubeTotalRow.shorts_counts),
                                            community_views: parseNumber(youtubeTotalRow.community_views),
                                            community_likes: parseNumber(youtubeTotalRow.community_likes),
                                            community_counts: parseNumber(youtubeTotalRow.community_counts)
                                        };
                                    }
                                    break;
                                case 'youtube-detail':
                                    const youtubeDetailFiltered = csvData.filter(row => {
                                        const dateValue = row['Date'] || ''; // CSV의 'Date' 컬럼
                                        if (dateValue.includes('년') && dateValue.includes('월')) {
                                            const yearMatch = dateValue.match(/(\d{4})년/);
                                            const monthMatch = dateValue.match(/(\d{1,2})월/);
                                            if (yearMatch && monthMatch) {
                                                const rowYear = yearMatch[1];
                                                const rowMonth = monthMatch[1].padStart(2, '0');
                                                return `${rowYear}_${rowMonth}` === targetMonth;
                                            }
                                        }
                                        return false;
                                    }).map(row => ({
                                        title: row['Title'],
                                        publish_date: row['Date'], // 원본 날짜 문자열 유지
                                        views: parseNumber(row['View']),
                                        click: parseNumber(row['Click']), // 'Click' 컬럼 추가
                                        likes: parseNumber(row['Likes']), // 'Likes' 컬럼 추가
                                        age_13_17: parseNumber(row['13-17']), // 연령대별 데이터도 가져옴
                                        age_18_24: parseNumber(row['18-24']),
                                        age_25_34: parseNumber(row['25-34']),
                                        age_35_44: parseNumber(row['35-44']),
                                        age_45_plus: parseNumber(row['45~']),
                                        note: row['Note'],
                                        // 썸네일과 링크는 CSV에 없으므로 플레이스홀더 사용
                                        thumbnail: `https://placehold.co/480x270/cccccc/333333?text=${encodeURIComponent(String(row['Title']).substring(0, 15))}`,
                                        link: `https://youtube.com/results?search_query=${encodeURIComponent(String(row['Title']))}` // 검색 링크로 대체
                                    }));
                                    reportData[targetMonth].youtube_detail = youtubeDetailFiltered;
                                    break;
                                case 'naver-total':
                                    const naverConvertedData = csvData.filter(row => {
                                        const dateValue = row.기간 || '';
                                        if (dateValue.includes('.')) {
                                            const [rowYear, rowMonth] = dateValue.split('.');
                                            return `${rowYear}_${rowMonth.padStart(2, '0')}` === targetMonth;
                                        }
                                        return false;
                                    });

                                    if (naverConvertedData.length > 0) {
                                        const naverLatest = naverConvertedData.find(row => row.연령 === '전 연령'); // '전 연령' 데이터만 사용
                                        if (naverLatest) {
                                            reportData[targetMonth].naver_cafe = {
                                                join: parseNumber(naverLatest['신규 가입자수']),
                                                posts: parseNumber(naverLatest['게시글수']),
                                                total_views: parseNumber(naverLatest['조회수']),
                                                comments: parseNumber(naverLatest['댓글수']),
                                                unique_visitors: parseNumber(naverLatest['방문횟수'])
                                            };
                                            // 연령대별 데이터도 함께 저장
                                            const ageData = {};
                                            ['10대', '20대', '30대', '40대 이상'].forEach(ageGroup => {
                                                const ageRow = naverConvertedData.find(row => row.연령 === ageGroup && row.기간 === naverLatest.기간);
                                                if (ageRow) {
                                                    ageData[ageGroup.replace(' ', '_').replace('이상', 'plus')] = parseNumber(ageRow['조회수']);
                                                }
                                            });
                                            reportData[targetMonth].age_distribution = ageData;
                                        }
                                    }
                                    break;
                            }
                        }
                    }
                }
                
                forceRefreshAll(); // 모든 UI 요소 강제 새로고침
                showNotification('데이터가 성공적으로 적용되었습니다! 🎉', 'success');
            } catch (error) {
                console.error('데이터 적용 오류:', error);
                showNotification('데이터 적용 오류: ' + error.message, 'error');
            }
        }

        // 모든 UI 요소 (테이블, 차트) 강제 새로고침
        function forceRefreshAll() {
            // 기존 차트 인스턴스 모두 파괴
            Object.values(chartInstances).forEach(chart => chart && chart.destroy());
            chartInstances = {}; // 인스턴스 초기화
            
            // 비동기적으로 데이터 및 차트 업데이트 (렌더링 지연 방지)
            setTimeout(() => { 
                updateYouTubeData(); 
                updateNaverData(); 
                updateCoverPageData(); // 표지 데이터 업데이트
                updateYoutubeDetailData(); // YouTube 상세 데이터 업데이트 추가
                updateYoutubeCommunityData(); // YouTube 커뮤니티 데이터 업데이트
                updateCustomPageData(); // 사용자 정의 페이지 데이터 업데이트
            }, 100);
            setTimeout(() => updateCharts(), 300);
        }

        // 월별 데이터 로드 (월 선택 드롭다운 변경 시 호출)
        function loadMonthData(month) {
            currentMonth = month; // 현재 월 업데이트
            forceRefreshAll(); // 모든 UI 새로고침
        }

        // 표지 데이터 업데이트
        function updateCoverPageData() {
            const currentReport = reportData[currentMonth];
            if (currentReport) {
                document.querySelector('[data-field="date"]').textContent = currentReport.date || '날짜 없음';
                document.getElementById('monthlySummary').textContent = 
                    `이 보고서는 ${currentReport.date.substring(0, 7).replace('.', '년 ')}월 클래시 로얄 커뮤니티 데이터를 종합 분석한 결과입니다.`;
            } else {
                document.querySelector('[data-field="date"]').textContent = '데이터 없음';
                document.getElementById('monthlySummary').textContent = '선택된 월의 데이터가 없습니다. CSV 파일을 업로드하여 데이터를 채워주세요.';
            }
            document.getElementById('cover-notes').innerHTML = editableContentStore['cover-notes'];
        }

        // YouTube 데이터 테이블 업데이트
        function updateYouTubeData() {
            const tbody = document.querySelector('#youtubeDataTable tbody');
            const months = ['2025_04', '2025_05', '2025_06']; // 표시할 월 (예시)
            
            // 테이블에 표시할 항목 정의
            const rows = [
                { label: '구독자', key: 'subscribers', format: v => v.toLocaleString() },
                { label: '총 영상 수', key: 'videos', format: v => v.toLocaleString() },
                { label: 'VOD 조회수', key: 'vod_views', format: v => v.toLocaleString() },
                { label: 'Shorts 조회수', key: 'shorts_views', format: v => v.toLocaleString() },
                { label: '총 좋아요 수', key: 'total_likes', format: v => v.toLocaleString() },
                { label: 'VOD 좋아요 수', key: 'vod_likes', format: v => v.toLocaleString() },
                { label: 'Shorts 좋아요 수', key: 'shorts_likes', format: v => v.toLocaleString() },
                { label: '총 게시물 수', key: 'total_counts', format: v => v.toLocaleString() },
                { label: 'VOD 게시물 수', key: 'vod_counts', format: v => v.toLocaleString() },
                { label: 'Shorts 게시물 수', key: 'shorts_counts', format: v => v.toLocaleString() }
            ];

            tbody.innerHTML = rows.map(row => {
                // 각 월별 데이터 추출
                const data = months.map(m => {
                    const yt = reportData[m]?.youtube;
                    return yt ? (yt[row.key] || 0) : 0;
                });
                
                // 변화율 계산 (6월 vs 5월)
                const prevMonthData = data[1]; // 5월 데이터
                const currentMonthData = data[2]; // 6월 데이터
                const change = prevMonthData > 0 ? ((currentMonthData - prevMonthData) / prevMonthData * 100) : 0;
                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : ''; // 변화율에 따른 색상 클래스

                return `<tr>
                    <td><strong>${row.label}</strong></td>
                    <td>${data[0].toLocaleString()}</td>
                    <td>${data[1].toLocaleString()}</td>
                    <td>${data[2].toLocaleString()}</td>
                    <td class="${changeClass}">${change > 0 ? '▲' : (change < 0 ? '▼' : '')} ${change.toFixed(1)}%</td>
                </tr>`;
            }).join('');

            document.getElementById('youtube-total-notes').innerHTML = editableContentStore['youtube-total-notes'];
        }

        // Naver Cafe 데이터 테이블 업데이트
        function updateNaverData() {
            const tbody = document.querySelector('#naverDataTable tbody');
            const months = ['2025_04', '2025_05', '2025_06']; // 표시할 월 (예시)
            
            // 테이블에 표시할 항목 정의
            const rows = [
                { label: '회원가입', key: 'join' },
                { label: '게시글', key: 'posts' },
                { label: '조회수', key: 'total_views' },
                { label: '댓글', key: 'comments' },
                { label: '방문자', key: 'unique_visitors' }
            ];

            tbody.innerHTML = rows.map(row => {
                // 각 월별 데이터 추출
                const data = months.map(m => reportData[m]?.naver_cafe?.[row.key] || 0);
                const total = data.reduce((sum, val) => sum + val, 0); // 총계 계산
                
                return `<tr>
                    <td><strong>${row.label}</strong></td>
                    <td>${data[0].toLocaleString()}</td>
                    <td>${data[1].toLocaleString()}</td>
                    <td>${data[2].toLocaleString()}</td>
                    <td><strong>${total.toLocaleString()}</strong></td>
                </tr>`;
            }).join('');

            document.getElementById('naver-total-notes').innerHTML = editableContentStore['naver-total-notes'];
        }

        // YouTube 상세 데이터 섹션 업데이트
        function updateYoutubeDetailData() {
            const currentDetailData = reportData[currentMonth]?.youtube_detail || [];
            const uploadedVideosGrid = document.getElementById('uploadedVideosGrid');
            const topVideosGrid = document.getElementById('topVideosGrid');
            const youtubeDetailSummary = document.getElementById('youtubeDetailSummary');

            uploadedVideosGrid.innerHTML = ''; // 기존 내용 지우기
            topVideosGrid.innerHTML = ''; // 기존 내용 지우기
            youtubeDetailSummary.innerHTML = ''; // 기존 내용 지우기

            if (currentDetailData.length === 0) {
                uploadedVideosGrid.innerHTML = '<p>이번 달에 업로드된 영상 데이터가 없습니다.</p>';
                topVideosGrid.innerHTML = '<p>인기 영상 데이터가 없습니다.</p>';
                youtubeDetailSummary.innerHTML = '<p>상세 요약 데이터가 없습니다.</p>';
                document.getElementById('youtube-detail-notes').innerHTML = editableContentStore['youtube-detail-notes'];
                return;
            }

            // 평균 데이터 계산
            let totalViews = 0;
            let totalClicks = 0; // 'Click' 컬럼 추가
            let totalLikes = 0; // 'Likes' 컬럼 추가
            currentDetailData.forEach(video => {
                totalViews += parseNumber(video.views);
                totalClicks += parseNumber(video.click);
                totalLikes += parseNumber(video.likes);
            });

            // Number() 변환과 || 0 을 사용하여 undefined 또는 NaN 방지
            const avgViews = Number(currentDetailData.length > 0 ? (totalViews / currentDetailData.length) : 0) || 0;
            const avgClicks = Number(currentDetailData.length > 0 ? (totalClicks / currentDetailData.length) : 0) || 0;
            const avgLikes = Number(currentDetailData.length > 0 ? (totalLikes / currentDetailData.length) : 0) || 0;

            youtubeDetailSummary.innerHTML = `
                <div class="metric-card">
                    <h4>평균 조회수</h4>
                    <p>${avgViews.toLocaleString(undefined, { maximumFractionDigits: 0 })}</p>
                </div>
                <div class="metric-card">
                    <h4>평균 클릭수</h4>
                    <p>${avgClicks.toLocaleString(undefined, { maximumFractionDigits: 0 })}</p>
                </div>
                <div class="metric-card">
                    <h4>평균 좋아요</h4>
                    <p>${avgLikes.toLocaleString(undefined, { maximumFractionDigits: 0 })}</p>
                </div>
            `;

            // 업로드된 영상 목록 표시
            currentDetailData.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                videoCard.innerHTML = `
                    <img src="${video.thumbnail || 'https://placehold.co/480x270/cccccc/333333?text=No+Thumbnail'}" alt="${video.title}" class="video-thumbnail">
                    <div class="video-info">
                        <h4>${video.title}</h4>
                        <p class="video-stats">조회수: ${parseNumber(video.views).toLocaleString()} | 클릭: ${parseNumber(video.click).toLocaleString()} | 좋아요: ${parseNumber(video.likes).toLocaleString()}</p>
                        <a href="${video.link}" target="_blank" class="video-link">영상 보기</a>
                    </div>
                `;
                uploadedVideosGrid.appendChild(videoCard);
            });

            // 조회수 기준 상위 3개 영상 표시
            const sortedVideos = [...currentDetailData].sort((a, b) => parseNumber(b.views) - parseNumber(a.views));
            sortedVideos.slice(0, 3).forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                videoCard.innerHTML = `
                    <img src="${video.thumbnail || 'https://placehold.co/480x270/cccccc/333333?text=No+Thumbnail'}" alt="${video.title}" class="video-thumbnail">
                    <div class="video-info">
                        <h4>${video.title}</h4>
                        <p class="video-stats">조회수: ${parseNumber(video.views).toLocaleString()} | 클릭: ${parseNumber(video.click).toLocaleString()} | 좋아요: ${parseNumber(video.likes).toLocaleString()}</p>
                        <a href="${video.link}" target="_blank" class="video-link">영상 보기</a>
                    </div>
                `;
                topVideosGrid.appendChild(videoCard);
            });

            document.getElementById('youtube-detail-notes').innerHTML = editableContentStore['youtube-detail-notes'];
        }

        // YouTube 커뮤니티 데이터 업데이트
        function updateYoutubeCommunityData() {
            const tbody = document.querySelector('#youtubeCommunityTable tbody');
            const months = ['2025_04', '2025_05', '2025_06']; // 표시할 월 (예시)

            const rows = [
                { label: '커뮤니티 조회수', key: 'community_views' },
                { label: '커뮤니티 좋아요', key: 'community_likes' },
                { label: '커뮤니티 게시물 수', key: 'community_counts' }
            ];

            tbody.innerHTML = rows.map(row => {
                const data = months.map(m => reportData[m]?.youtube?.[row.key] || 0);
                const total = data.reduce((sum, val) => sum + val, 0);

                return `<tr>
                    <td><strong>${row.label}</strong></td>
                    <td>${data[0].toLocaleString()}</td>
                    <td>${data[1].toLocaleString()}</td>
                    <td>${data[2].toLocaleString()}</td>
                    <td><strong>${total.toLocaleString()}</strong></td>
                </tr>`;
            }).join('');

            document.getElementById('youtube-community-notes').innerHTML = editableContentStore['youtube-community-notes'];
        }


        // Chart.js 전역 설정 초기화
        function initializeCharts() {
            Chart.defaults.animation = { duration: 1500, easing: 'easeInOutQuart' }; // 애니메이션 설정
            Chart.defaults.font.family = "'Segoe UI', sans-serif"; // 폰트 설정
        }

        // 모든 차트 업데이트
        function updateCharts() {
            updateYouTubeCharts();
            updateNaverCharts();
        }

        // YouTube 차트 업데이트
        function updateYouTubeCharts() {
            const months = ['4월', '5월', '6월']; // 차트 레이블
            const monthKeys = ['2025_04', '2025_05', '2025_06']; // reportData 키

            // YouTube 차트 1: 구독자 수 & 영상 수 (막대 차트)
            const ctx1 = document.getElementById('youtubeChart1');
            if (ctx1 && chartInstances.youtubeChart1) chartInstances.youtubeChart1.destroy(); // 기존 차트 파괴
            
            if (ctx1) {
                chartInstances.youtubeChart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: '구독자 수',
                            data: monthKeys.map(m => reportData[m]?.youtube?.subscribers || 0),
                            backgroundColor: colorSchemes.blue[0]
                        }, {
                            label: '총 영상 수',
                            data: monthKeys.map(m => reportData[m]?.youtube?.videos || 0),
                            backgroundColor: colorSchemes.blue[1]
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false } // 반응형, 비율 유지 안 함
                });
            }

            // YouTube 차트 1 요약 테이블 업데이트
            const youtubeChart1TableBody = document.querySelector('#youtubeChart1Table tbody');
            const youtubeChart1TableData = [
                { label: '구독자 수', keys: ['subscribers'] },
                { label: '총 영상 수', keys: ['videos'] }
            ];
            youtubeChart1TableBody.innerHTML = youtubeChart1TableData.map(row => {
                const rowValues = months.map((_, index) => {
                    const monthData = reportData[monthKeys[index]]?.youtube;
                    return row.keys.reduce((sum, key) => sum + (monthData?.[key] || 0), 0);
                });
                return `<tr>
                    <td><strong>${row.label}</strong></td>
                    <td>${rowValues[0].toLocaleString()}</td>
                    <td>${rowValues[1].toLocaleString()}</td>
                    <td>${rowValues[2].toLocaleString()}</td>
                </tr>`;
            }).join('');


            // YouTube 차트 2: 총 조회수 & 좋아요 (선 차트)
            const ctx2 = document.getElementById('youtubeChart2');
            if (ctx2 && chartInstances.youtubeChart2) chartInstances.youtubeChart2.destroy();
            
            if (ctx2) {
                chartInstances.youtubeChart2 = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: '총 조회수',
                            data: monthKeys.map(m => {
                                const yt = reportData[m]?.youtube;
                                return (yt?.vod_views || 0) + (yt?.shorts_views || 0); // VOD + Shorts 조회수 합산
                            }),
                            borderColor: colorSchemes.red[0],
                            backgroundColor: colorSchemes.red[0] + '20', // 투명도 추가
                            tension: 0.4, // 곡선 부드럽게
                            fill: true
                        },
                        {
                            label: '총 좋아요 수',
                            data: monthKeys.map(m => reportData[m]?.youtube?.total_likes || 0),
                            borderColor: colorSchemes.red[1],
                            backgroundColor: colorSchemes.red[1] + '20',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // YouTube 차트 2 요약 테이블 업데이트
            const youtubeChart2TableBody = document.querySelector('#youtubeChart2Table tbody');
            const youtubeChart2TableData = [
                { label: '총 조회수', keys: ['vod_views', 'shorts_views'] },
                { label: '총 좋아요 수', keys: ['total_likes'] }
            ];
            youtubeChart2TableBody.innerHTML = youtubeChart2TableData.map(row => {
                const rowValues = months.map((_, index) => {
                    const monthData = reportData[monthKeys[index]]?.youtube;
                    return row.keys.reduce((sum, key) => sum + (monthData?.[key] || 0), 0);
                });
                return `<tr>
                    <td><strong>${row.label}</strong></td>
                    <td>${rowValues[0].toLocaleString()}</td>
                    <td>${rowValues[1].toLocaleString()}</td>
                    <td>${rowValues[2].toLocaleString()}</td>
                </tr>`;
            }).join('');

            document.getElementById('youtube-charts-notes').innerHTML = editableContentStore['youtube-charts-notes'];
        }

        // Naver Cafe 차트 업데이트
        function updateNaverCharts() {
            const months = ['4월', '5월', '6월'];
            const monthKeys = ['2025_04', '2025_05', '2025_06'];

            // Naver Cafe 차트 1: 게시글 & 댓글 수 (막대 차트)
            const ctx1 = document.getElementById('naverChart1');
            if (ctx1 && chartInstances.naverChart1) chartInstances.naverChart1.destroy();
            
            if (ctx1) {
                chartInstances.naverChart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: '게시글',
                            data: monthKeys.map(m => reportData[m]?.naver_cafe?.posts || 0),
                            backgroundColor: colorSchemes.green[0]
                        }, {
                            label: '댓글',
                            data: monthKeys.map(m => reportData[m]?.naver_cafe?.comments || 0),
                            backgroundColor: colorSchemes.green[1]
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Naver Cafe 차트 1 요약 테이블 업데이트
            const naverChart1TableBody = document.querySelector('#naverChart1Table tbody');
            const naverChart1TableData = [
                { label: '게시글', keys: ['posts'] },
                { label: '댓글', keys: ['comments'] }
            ];
            naverChart1TableBody.innerHTML = naverChart1TableData.map(row => {
                const rowValues = months.map((_, index) => {
                    const monthData = reportData[monthKeys[index]]?.naver_cafe;
                    return row.keys.reduce((sum, key) => sum + (monthData?.[key] || 0), 0);
                });
                return `<tr>
                    <td><strong>${row.label}</strong></td>
                    <td>${rowValues[0].toLocaleString()}</td>
                    <td>${rowValues[1].toLocaleString()}</td>
                    <td>${rowValues[2].toLocaleString()}</td>
                </tr>`;
            }).join('');

            // Naver Cafe 차트 2: 연령대별 분포 (누적 막대 차트)
            const ageCtx = document.getElementById('ageChart');
            if (ageCtx && chartInstances.ageChart) chartInstances.ageChart.destroy();
            
            if (ageCtx) {
                chartInstances.ageChart = new Chart(ageCtx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            { label: '10대', data: monthKeys.map(m => reportData[m]?.age_distribution?.['10대'] || 0), backgroundColor: colorSchemes.blue[0] },
                            { label: '20대', data: monthKeys.map(m => reportData[m]?.age_distribution?.['20대'] || 0), backgroundColor: colorSchemes.blue[1] },
                            { label: '30대', data: monthKeys.map(m => reportData[m]?.age_distribution?.['30대'] || 0), backgroundColor: colorSchemes.blue[2] },
                            { label: '40대+', data: monthKeys.map(m => reportData[m]?.age_distribution?.['40대 이상'] || 0), backgroundColor: colorSchemes.red[0] }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            x: { stacked: true }, // x축 누적
                            y: { stacked: true }  // y축 누적
                        } 
                    }
                });
            }

            // Naver Cafe 차트 2 요약 테이블 업데이트
            const ageChartTableBody = document.querySelector('#ageChartTable tbody');
            const ageChartTableData = [
                { label: '10대', keys: ['10대'] },
                { label: '20대', keys: ['20대'] },
                { label: '30대', keys: ['30대'] },
                { label: '40대+', keys: ['40대 이상'] }
            ];
            ageChartTableBody.innerHTML = ageChartTableData.map(row => {
                const rowValues = months.map((_, index) => {
                    const monthData = reportData[monthKeys[index]]?.age_distribution;
                    return row.keys.reduce((sum, key) => sum + (monthData?.[key] || 0), 0);
                });
                return `<tr>
                    <td><strong>${row.label}</strong></td>
                    <td>${rowValues[0].toLocaleString()}</td>
                    <td>${rowValues[1].toLocaleString()}</td>
                    <td>${rowValues[2].toLocaleString()}</td>
                </tr>`;
            }).join('');

            document.getElementById('naver-charts-notes').innerHTML = editableContentStore['naver-charts-notes'];
        }

        // 차트 색상 변경 (드롭다운 선택에 따라)
        function updateChartColors(chartId, colorScheme) {
            const chart = chartInstances[chartId];
            if (!chart) return;
            
            const colors = colorSchemes[colorScheme]; // 선택된 색상 스키마 가져오기
            chart.data.datasets.forEach((dataset, index) => {
                dataset.backgroundColor = colors[index % colors.length]; // 데이터셋 배경색 변경
                dataset.borderColor = colors[index % colors.length]; // 데이터셋 테두리 색상 변경
            });
            chart.update(); // 차트 업데이트
        }

        // CSV 업로드 정보 (예상 형식) 업데이트
        function updateCsvUploadInfo() {
            const selector = document.getElementById('pageDataSelector');
            const section = document.getElementById('csvUploadSection');
            const formatInfo = document.getElementById('csvFormatInfo');
            
            if (selector.value) {
                section.style.display = 'block'; // CSV 업로드 섹션 표시
                const fields = selector.selectedOptions[0].dataset.fields; // data-fields 속성 값 가져오기
                if (fields) {
                    formatInfo.textContent = fields.split(',').join(', ') + '\n\n예시:\n' + fields.split(',').map(f => '값').join(', ');
                } else {
                    formatInfo.textContent = '선택된 페이지에 대한 예상 CSV 형식이 없습니다.';
                }
            } else {
                section.style.display = 'none'; // 페이지 선택 안 하면 숨김
            }
            document.getElementById('dataPreview').style.display = 'none'; // 페이지 선택 변경 시 미리보기 숨김
            currentCsvData = null; // 현재 미리보기 데이터 초기화
        }

        // 편집 모드 토글 (현재는 관리자 패널로 대체)
        function toggleEditMode() {
            // 이 함수는 이제 관리자 패널의 '콘텐츠 편집' 탭으로 대체됩니다.
            // 직접적인 페이지 편집은 비활성화됩니다.
            showNotification('콘텐츠 편집은 관리자 패널에서 가능합니다.', 'info');
        }

        // 관리자 패널 열기
        function openAdminPanel() {
            document.getElementById('adminModal').classList.add('active'); // 모달 활성화
            document.body.style.overflow = 'hidden'; // 스크롤 방지
            loadContentForEdit(); // 콘텐츠 편집기 초기 로드
        }

        // 관리자 패널 닫기
        function closeAdminPanel() {
            document.getElementById('adminModal').classList.remove('active'); // 모달 비활성화
            document.body.style.overflow = 'auto'; // 스크롤 허용
        }

        // 관리자 탭 전환
        function switchTab(event, tabName) {
            // 모든 탭 버튼의 'active' 클래스 제거
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active'); // 클릭된 탭 버튼에 'active' 클래스 추가
            
            // 모든 섹션의 'active' 클래스 제거
            document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
            document.getElementById(tabName + '-section').classList.add('active'); // 해당 섹션 활성화

            if (tabName === 'content') {
                loadContentForEdit(); // 콘텐츠 편집 탭으로 이동 시 내용 로드
            }
        }

        // 콘텐츠 편집기: 선택된 섹션의 내용을 로드
        function loadContentForEdit() {
            const selector = document.getElementById('contentEditorSelector');
            const editor = document.getElementById('contentEditor');
            const imageEditGroup = document.getElementById('imageEditGroup');
            const imageEditor = document.getElementById('imageEditor');
            const selectedSection = selector.value;

            imageEditGroup.style.display = 'none'; // 기본적으로 이미지 편집 그룹 숨김

            if (selectedSection === 'monthlySummary') {
                editor.value = editableContentStore.monthlySummary;
            } else if (selectedSection.endsWith('-notes')) {
                editor.value = editableContentStore[selectedSection];
            } else if (selectedSection === 'custom-page-1') {
                editor.value = editableContentStore["custom-page-1"].content;
                imageEditor.value = editableContentStore["custom-page-1"].image;
                imageEditGroup.style.display = 'block';
            }
        }

        // 콘텐츠 편집기: 변경된 내용을 저장
        function saveContentChanges() {
            const selector = document.getElementById('contentEditorSelector');
            const editor = document.getElementById('contentEditor');
            const imageEditor = document.getElementById('imageEditor');
            const selectedSection = selector.value;

            if (selectedSection === 'monthlySummary') {
                editableContentStore.monthlySummary = editor.value;
                document.getElementById('monthlySummary').innerHTML = editor.value;
            } else if (selectedSection.endsWith('-notes')) {
                editableContentStore[selectedSection] = editor.value;
                document.getElementById(selectedSection).innerHTML = editor.value;
            } else if (selectedSection === 'custom-page-1') {
                editableContentStore["custom-page-1"].content = editor.value;
                editableContentStore["custom-page-1"].image = imageEditor.value;
                updateCustomPageData(); // 사용자 정의 페이지 업데이트 함수 호출
            }
            showNotification('콘텐츠가 저장되었습니다!', 'success');
        }

        // 사용자 정의 페이지 데이터 업데이트 (콘텐츠 편집기에서 저장 시 호출)
        function updateCustomPageData() {
            const customPageTitle = document.getElementById('custom-page-1-title');
            const customPageSubtitle = document.getElementById('custom-page-1-subtitle');
            const customPageContent = document.getElementById('custom-page-1-content');
            const customPageImage = document.getElementById('custom-page-1-image');

            if (customPageTitle) {
                customPageTitle.textContent = editableContentStore["custom-page-1"].title;
            }
            if (customPageSubtitle) {
                customPageSubtitle.textContent = editableContentStore["custom-page-1"].subtitle;
            }
            if (customPageContent) {
                customPageContent.innerHTML = editableContentStore["custom-page-1"].content;
            }
            if (customPageImage) {
                customPageImage.src = editableContentStore["custom-page-1"].image;
            }
            document.getElementById('custom-page-1-notes').innerHTML = editableContentStore['custom-page-1-notes'];
        }


        // 테마 적용 (라이트/다크)
        function applyTheme() {
            const theme = document.getElementById('themeSelector').value;
            if (theme === 'dark') {
                document.documentElement.style.setProperty('--primary', '#ffffff');
                document.documentElement.style.setProperty('--secondary', '#1a1a1a');
                document.documentElement.style.setProperty('--text', '#ffffff');
                document.documentElement.style.setProperty('--border', '#404040');
                document.documentElement.style.setProperty('--hover', '#333333');
            } else {
                document.documentElement.style.setProperty('--primary', '#1a1a1a');
                document.documentElement.style.setProperty('--secondary', '#ffffff');
                document.documentElement.style.setProperty('--text', '#111827');
                document.documentElement.style.setProperty('--border', '#e5e7eb');
                document.documentElement.style.setProperty('--hover', '#f9fafb');
            }
            showNotification('테마가 적용되었습니다', 'success');
        }

        // 보고서 내보내기 (HTML 또는 PDF)
        function exportReport() {
            const format = document.getElementById('exportFormat').value;
            if (format === 'html') {
                const html = document.documentElement.outerHTML; // 전체 HTML 가져오기
                const blob = new Blob([html], { type: 'text/html' }); // Blob 생성
                const url = URL.createObjectURL(blob); // URL 생성
                const a = document.createElement('a'); // <a> 태그 생성
                a.href = url; 
                a.download = `clash_royale_report_${currentMonth}.html`; // 파일명 설정
                a.click(); // 클릭하여 다운로드
                URL.revokeObjectURL(url); // URL 해제
            } else if (format === 'pdf') {
                // html2pdf 라이브러리 사용
                html2pdf().from(document.getElementById('mainContent')).save(`clash_royale_report_${currentMonth}.pdf`);
            }
            showNotification('보고서가 내보내졌습니다', 'success');
        }

        // 디버그 정보 콘솔 출력
        function debugDataFlow() {
            console.log('=== 디버그 정보 ===');
            console.log('현재 월:', currentMonth);
            console.log('reportData:', reportData);
            console.log('csvDataStore:', csvDataStore);
            console.log('chartInstances:', Object.keys(chartInstances));
            console.log('editableContentStore:', editableContentStore);
            showNotification('디버그 정보가 콘솔에 출력되었습니다', 'info');
        }

        // 사용자 알림 메시지 표시
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`; // 타입에 따라 클래스 변경 (색상)
            notification.classList.add('show'); // 'show' 클래스 추가하여 애니메이션 시작
            setTimeout(() => notification.classList.remove('show'), 3000); // 3초 후 'show' 클래스 제거
        }

        // 디버깅을 위한 전역 객체 노출
        window.debugReport = { currentMonth, reportData, csvDataStore, chartInstances, editableContentStore };
        
        console.log('🎮 클래시 로얄 월간 커뮤니티 리뷰 시스템 v6.0 (컴팩트) 로드 완료! ✨');
        console.log('📊 사용법: 관리자 패널 → 데이터 관리 → CSV 업로드 → 데이터 적용');
        console.log('📝 콘텐츠 편집: 관리자 패널 → 콘텐츠 편집 탭');
    </script>
</body>
</html>
